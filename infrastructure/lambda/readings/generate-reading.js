"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_ssm_1 = require("@aws-sdk/client-ssm");
const client_s3_1 = require("@aws-sdk/client-s3");
const uuid_1 = require("uuid");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const dynamoDoc = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const ssmClient = new client_ssm_1.SSMClient({});
const s3Client = new client_s3_1.S3Client({});
// Cache configuration on cold start
let cachedConfig = null;
// Fallback prompts in case S3 fails
const FALLBACK_SYSTEM_PROMPT = 'You are an expert astrologer providing Soul Blueprint readings based on natal charts.';
const FALLBACK_USER_TEMPLATE = `Generate a Soul Blueprint reading for:
Name: {{birthName}}
Birth: {{birthDate}} {{birthTime}}
Location: {{birthCity}}, {{birthState}}, {{birthCountry}}

Natal Chart:
{{natalChartData}}

Provide insights on sun sign, moon sign, rising sign, and life path.`;
async function fetchS3Content(bucket, key) {
    try {
        const response = await s3Client.send(new client_s3_1.GetObjectCommand({
            Bucket: bucket,
            Key: key,
        }));
        const content = await response.Body?.transformToString() || '';
        console.log(`Fetched S3 object: ${key}, ETag: ${response.ETag}`);
        return { content, etag: response.ETag };
    }
    catch (error) {
        console.error(`Failed to fetch S3 object ${key}:`, error);
        throw error;
    }
}
async function getOpenAIConfig() {
    // Return cached config if available
    if (cachedConfig) {
        console.log('Using cached configuration');
        return cachedConfig.config;
    }
    console.log('Loading configuration from SSM and S3...');
    const parameterNames = [
        process.env.OPENAI_API_KEY_PARAMETER_NAME,
        process.env.READING_MODEL_PARAMETER_NAME,
        process.env.READING_TEMPERATURE_PARAMETER_NAME,
        process.env.READING_MAX_TOKENS_PARAMETER_NAME,
        process.env.SYSTEM_PROMPT_S3KEY_PARAMETER_NAME,
        process.env.USER_PROMPT_S3KEY_PARAMETER_NAME,
    ];
    const bucketName = process.env.CONFIG_BUCKET_NAME;
    if (!bucketName) {
        throw new Error('CONFIG_BUCKET_NAME environment variable not set');
    }
    // Validate all parameter names are present
    const missingParams = parameterNames
        .map((name, index) => {
        const labels = [
            'OPENAI_API_KEY_PARAMETER_NAME',
            'READING_MODEL_PARAMETER_NAME',
            'READING_TEMPERATURE_PARAMETER_NAME',
            'READING_MAX_TOKENS_PARAMETER_NAME',
            'SYSTEM_PROMPT_S3KEY_PARAMETER_NAME',
            'USER_PROMPT_S3KEY_PARAMETER_NAME',
        ];
        return name ? null : labels[index];
    })
        .filter(Boolean);
    if (missingParams.length > 0) {
        throw new Error(`Missing environment variables: ${missingParams.join(', ')}`);
    }
    // Fetch all SSM parameters in parallel
    const parameterPromises = parameterNames.map((name) => ssmClient.send(new client_ssm_1.GetParameterCommand({
        Name: name,
        WithDecryption: true,
    })));
    const responses = await Promise.all(parameterPromises);
    // Extract SSM values
    const ssmValues = responses.map((response, index) => {
        if (!response.Parameter?.Value) {
            throw new Error(`Parameter ${parameterNames[index]} not found in SSM`);
        }
        return response.Parameter.Value;
    });
    // Log parameter names (not values) for debugging
    console.log('Loaded SSM parameters:', {
        model: process.env.READING_MODEL_PARAMETER_NAME,
        temperature: process.env.READING_TEMPERATURE_PARAMETER_NAME,
        maxTokens: process.env.READING_MAX_TOKENS_PARAMETER_NAME,
        systemPromptKey: ssmValues[4],
        userPromptKey: ssmValues[5],
    });
    // Fetch prompts from S3
    let systemPrompt = FALLBACK_SYSTEM_PROMPT;
    let userPromptTemplate = FALLBACK_USER_TEMPLATE;
    let systemETag;
    let userETag;
    try {
        const [systemResult, userResult] = await Promise.all([
            fetchS3Content(bucketName, ssmValues[4]),
            fetchS3Content(bucketName, ssmValues[5]),
        ]);
        systemPrompt = systemResult.content || FALLBACK_SYSTEM_PROMPT;
        userPromptTemplate = userResult.content || FALLBACK_USER_TEMPLATE;
        systemETag = systemResult.etag;
        userETag = userResult.etag;
    }
    catch (error) {
        console.error('Failed to fetch prompts from S3, using fallback prompts:', error);
    }
    const config = {
        apiKey: ssmValues[0],
        model: ssmValues[1],
        temperature: parseFloat(ssmValues[2]),
        maxTokens: parseInt(ssmValues[3], 10),
        systemPrompt,
        userPromptTemplate,
    };
    // Cache the configuration
    cachedConfig = {
        config,
        systemPromptETag: systemETag,
        userPromptETag: userETag,
    };
    return config;
}
async function getUserProfile(userId) {
    const response = await dynamoDoc.send(new lib_dynamodb_1.GetCommand({
        TableName: process.env.USER_TABLE_NAME,
        Key: {
            userId,
            createdAt: 'PROFILE',
        },
    }));
    return response.Item;
}
async function getNatalChart(userId) {
    const response = await dynamoDoc.send(new lib_dynamodb_1.GetCommand({
        TableName: process.env.NATAL_CHART_TABLE_NAME,
        Key: {
            userId,
        },
    }));
    return response.Item;
}
async function callOpenAI(prompt, config) {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${config.apiKey}`,
        },
        body: JSON.stringify({
            model: config.model,
            messages: [
                {
                    role: 'system',
                    content: config.systemPrompt,
                },
                {
                    role: 'user',
                    content: prompt,
                },
            ],
            temperature: config.temperature,
            max_tokens: config.maxTokens,
        }),
    });
    if (!response.ok) {
        const error = await response.text();
        throw new Error(`OpenAI API error: ${response.status} - ${error}`);
    }
    const data = (await response.json());
    return data.choices[0].message.content;
}
const handler = async (event) => {
    console.log('Event:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'POST,OPTIONS',
    };
    try {
        // Extract userId from path
        const userId = event.pathParameters?.userId;
        if (!userId) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({ message: 'userId is required' }),
            };
        }
        // Verify authenticated user matches requested userId
        const requestContext = event.requestContext;
        const authenticatedUserId = requestContext?.authorizer?.claims?.sub;
        if (authenticatedUserId !== userId) {
            return {
                statusCode: 403,
                headers: corsHeaders,
                body: JSON.stringify({ message: 'Unauthorized to generate reading for this user' }),
            };
        }
        // Get user profile and natal chart
        const [userProfile, natalChart] = await Promise.all([
            getUserProfile(userId),
            getNatalChart(userId),
        ]);
        if (!userProfile) {
            return {
                statusCode: 404,
                headers: corsHeaders,
                body: JSON.stringify({ message: 'User profile not found' }),
            };
        }
        if (!natalChart) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({
                    message: 'Natal chart not generated. Please complete your profile first.',
                }),
            };
        }
        // Generate reading ID and timestamp
        const readingId = (0, uuid_1.v4)();
        const timestamp = new Date().toISOString();
        // Create the reading record with status 'Processing'
        const readingRecord = {
            userId,
            readingId,
            type: 'Soul Blueprint',
            status: 'Processing',
            createdAt: timestamp,
            updatedAt: timestamp,
        };
        // Save initial reading record
        await dynamoDoc.send(new lib_dynamodb_1.PutCommand({
            TableName: process.env.READINGS_TABLE_NAME,
            Item: readingRecord,
        }));
        try {
            // Get OpenAI configuration
            const openAIConfig = await getOpenAIConfig();
            // Build user prompt from template
            const userPrompt = openAIConfig.userPromptTemplate
                .replace('{{birthName}}', userProfile.profile?.birthName || 'Unknown')
                .replace('{{birthDate}}', userProfile.profile?.birthDate || 'Unknown')
                .replace('{{birthTime}}', userProfile.profile?.birthTime || 'Unknown')
                .replace('{{birthCity}}', userProfile.profile?.birthCity || 'Unknown')
                .replace('{{birthState}}', userProfile.profile?.birthState || 'Unknown')
                .replace('{{birthCountry}}', userProfile.profile?.birthCountry || 'Unknown')
                .replace('{{natalChartData}}', JSON.stringify(natalChart, null, 2));
            // Call OpenAI API
            const content = await callOpenAI(userPrompt, openAIConfig);
            // Update reading with content and status
            const updatedReading = {
                ...readingRecord,
                content,
                status: 'Ready',
                updatedAt: new Date().toISOString(),
            };
            await dynamoDoc.send(new lib_dynamodb_1.PutCommand({
                TableName: process.env.READINGS_TABLE_NAME,
                Item: updatedReading,
            }));
            return {
                statusCode: 200,
                headers: corsHeaders,
                body: JSON.stringify({
                    message: 'Reading generated successfully',
                    readingId,
                    status: 'Ready',
                }),
            };
        }
        catch (error) {
            console.error('Error generating reading:', error);
            // Update reading status to Failed
            await dynamoDoc.send(new lib_dynamodb_1.PutCommand({
                TableName: process.env.READINGS_TABLE_NAME,
                Item: {
                    ...readingRecord,
                    status: 'Failed',
                    error: error instanceof Error ? error.message : 'Unknown error',
                    updatedAt: new Date().toISOString(),
                },
            }));
            throw error;
        }
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({
                message: 'Failed to generate reading',
                error: error instanceof Error ? error.message : 'Unknown error',
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUtcmVhZGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdlbmVyYXRlLXJlYWRpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUF1RjtBQUN2RixvREFBcUU7QUFDckUsa0RBQWdFO0FBQ2hFLCtCQUFvQztBQUVwQyxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQzVELE1BQU0sU0FBUyxHQUFHLElBQUksc0JBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNwQyxNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7QUFpQmxDLG9DQUFvQztBQUNwQyxJQUFJLFlBQVksR0FBd0IsSUFBSSxDQUFDO0FBRTdDLG9DQUFvQztBQUNwQyxNQUFNLHNCQUFzQixHQUFHLHVGQUF1RixDQUFDO0FBQ3ZILE1BQU0sc0JBQXNCLEdBQUc7Ozs7Ozs7O3FFQVFzQyxDQUFDO0FBRXRFLEtBQUssVUFBVSxjQUFjLENBQUMsTUFBYyxFQUFFLEdBQVc7SUFDdkQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxDQUNsQyxJQUFJLDRCQUFnQixDQUFDO1lBQ25CLE1BQU0sRUFBRSxNQUFNO1lBQ2QsR0FBRyxFQUFFLEdBQUc7U0FDVCxDQUFDLENBQ0gsQ0FBQztRQUVGLE1BQU0sT0FBTyxHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUMvRCxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixHQUFHLFdBQVcsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFFakUsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsUUFBUSxD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YUFBYTtvQkFDaEIsTUFBTSxFQUFFLFFBQVE7b0JBQ2hCLEtBQUssRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO29CQUMvRCxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7aUJBQ3BDO2FBQ0YsQ0FBQyxDQUNILENBQUM7WUFFRixNQUFNLEtBQUssQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQy9CLE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRSxXQUFXO1lBQ3BCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNuQixPQUFPLEVBQUUsNEJBQTRCO2dCQUNyQyxLQUFLLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZTthQUNoRSxDQUFDO1NBQ0gsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDLENBQUM7QUFuSlcsUUFBQSxPQUFPLFdBbUpsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFB1dENvbW1hbmQsIEdldENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgU1NNQ2xpZW50LCBHZXRQYXJhbWV0ZXJDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNzbSc7XG5pbXBvcnQgeyBTM0NsaWVudCwgR2V0T2JqZWN0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcblxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGR5bmFtb0RvYyA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkeW5hbW9DbGllbnQpO1xuY29uc3Qgc3NtQ2xpZW50ID0gbmV3IFNTTUNsaWVudCh7fSk7XG5jb25zdCBzM0NsaWVudCA9IG5ldyBTM0NsaWVudCh7fSk7XG5cbmludGVyZmFjZSBPcGVuQUlDb25maWcge1xuICBhcGlLZXk6IHN0cmluZztcbiAgbW9kZWw6IHN0cmluZztcbiAgdGVtcGVyYXR1cmU6IG51bWJlcjtcbiAgbWF4VG9rZW5zOiBudW1iZXI7XG4gIHN5c3RlbVByb21wdDogc3RyaW5nO1xuICB1c2VyUHJvbXB0VGVtcGxhdGU6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIENhY2hlZENvbmZpZyB7XG4gIGNvbmZpZzogT3BlbkFJQ29uZmlnO1xuICBzeXN0ZW1Qcm9tcHRFVGFnPzogc3RyaW5nO1xuICB1c2VyUHJvbXB0RVRhZz86IHN0cmluZztcbn1cblxuLy8gQ2FjaGUgY29uZmlndXJhdGlvbiBvbiBjb2xkIHN0YXJ0XG5sZXQgY2FjaGVkQ29uZmlnOiBDYWNoZWRDb25maWcgfCBudWxsID0gbnVsbDtcblxuLy8gRmFsbGJhY2sgcHJvbXB0cyBpbiBjYXNlIFMzIGZhaWxzXG5jb25zdCBGQUxMQkFDS19TWVNURU1fUFJPTVBUID0gJ1lvdSBhcmUgYW4gZXhwZXJ0IGFzdHJvbG9nZXIgcHJvdmlkaW5nIFNvdWwgQmx1ZXByaW50IHJlYWRpbmdzIGJhc2VkIG9uIG5hdGFsIGNoYXJ0cy4nO1xuY29uc3QgRkFMTEJBQ0tfVVNFUl9URU1QTEFURSA9IGBHZW5lcmF0ZSBhIFNvdWwgQmx1ZXByaW50IHJlYWRpbmcgZm9yOlxuTmFtZToge3tiaXJ0aE5hbWV9fVxuQmlydGg6IHt7YmlydGhEYXRlfX0ge3tiaXJ0aFRpbWV9fVxuTG9jYXRpb246IHt7YmlydGhDaXR5fX0sIHt7YmlydGhTdGF0ZX19LCB7e2JpcnRoQ291bnRyeX19XG5cbk5hdGFsIENoYXJ0Olxue3tuYXRhbENoYXJ0RGF0YX19XG5cblByb3ZpZGUgaW5zaWdodHMgb24gc3VuIHNpZ24sIG1vb24gc2lnbiwgcmlzaW5nIHNpZ24sIGFuZCBsaWZlIHBhdGguYDtcblxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hTM0NvbnRlbnQoYnVja2V0OiBzdHJpbmcsIGtleTogc3RyaW5nKTogUHJvbWlzZTx7IGNvbnRlbnQ6IHN0cmluZzsgZXRhZz86IHN0cmluZyB9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzM0NsaWVudC5zZW5kKFxuICAgICAgbmV3IEdldE9iamVjdENvbW1hbmQoe1xuICAgICAgICBCdWNrZXQ6IGJ1Y2tldCxcbiAgICAgICAgS2V5OiBrZXksXG4gICAgICB9KSxcbiAgICApO1xuICAgIFxuICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCByZXNwb25zZS5Cb2R5Py50cmFuc2Zvcm1Ub1N0cmluZygpIHx8ICcnO1xuICAgIGNvbnNvbGUubG9nKGBGZXRjaGVkIFMzIG9iamVjdDogJHtrZXl9LCBFVGFnOiAke3Jlc3BvbnNlLkVUYWd9YCk7XG4gICAgXG4gICAgcmV0dXJuIHsgY29udGVudCwgZXRhZzogcmVzcG9uc2UuRVRhZyB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBmZXRjaCBTMyBvYmplY3QgJHtrZXl9OmAsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRPcGVuQUlDb25maWcoKTogUHJvbWlzZTxPcGVuQUlDb25maWc+IHtcbiAgLy8gUmV0dXJuIGNhY2hlZCBjb25maWcgaWYgYXZhaWxhYmxlXG4gIGlmIChjYWNoZWRDb25maWcpIHtcbiAgICBjb25zb2xlLmxvZygnVXNpbmcgY2FjaGVkIGNvbmZpZ3VyYXRpb24nKTtcbiAgICByZXR1cm4gY2FjaGVkQ29uZmlnLmNvbmZpZztcbiAgfVxuXG4gIGNvbnNvbGUubG9nKCdMb2FkaW5nIGNvbmZpZ3VyYXRpb24gZnJvbSBTU00gYW5kIFMzLi4uJyk7XG4gIFxuICBjb25zdCBwYXJhbWV0ZXJOYW1lcyA9IFtcbiAgICBwcm9jZXNzLmVudi5PUEVOQUlfQVBJX0tFWV9QQVJBTUVURVJfTkFNRSxcbiAgICBwcm9jZXNzLmVudi5SRUFESU5HX01PREVMX1BBUkFNRVRFUl9OQU1FLFxuICAgIHByb2Nlc3MuZW52LlJFQURJTkdfVEVNUEVSQVRVUkVfUEFSQU1FVEVSX05BTUUsXG4gICAgcHJvY2Vzcy5lbnYuUkVBRElOR19NQVhfVE9LRU5TX1BBUkFNRVRFUl9OQU1FLFxuICAgIHByb2Nlc3MuZW52LlNZU1RFTV9QUk9NUFRfUzNLRVlfUEFSQU1FVEVSX05BTUUsXG4gICAgcHJvY2Vzcy5lbnYuVVNFUl9QUk9NUFRfUzNLRVlfUEFSQU1FVEVSX05BTUUsXG4gIF07XG5cbiAgY29uc3QgYnVja2V0TmFtZSA9IHByb2Nlc3MuZW52LkNPTkZJR19CVUNLRVRfTkFNRTtcbiAgXG4gIGlmICghYnVja2V0TmFtZSkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ09ORklHX0JVQ0tFVF9OQU1FIGVudmlyb25tZW50IHZhcmlhYmxlIG5vdCBzZXQnKTtcbiAgfVxuXG4gIC8vIFZhbGlkYXRlIGFsbCBwYXJhbWV0ZXIgbmFtZXMgYXJlIHByZXNlbnRcbiAgY29uc3QgbWlzc2luZ1BhcmFtcyA9IHBhcmFtZXRlck5hbWVzXG4gICAgLm1hcCgobmFtZSwgaW5kZXgpID0+IHtcbiAgICAgIGNvbnN0IGxhYmVscyA9IFtcbiAgICAgICAgJ09QRU5BSV9BUElfS0VZX1BBUkFNRVRFUl9OQU1FJyxcbiAgICAgICAgJ1JFQURJTkdfTU9ERUxfUEFSQU1FVEVSX05BTUUnLFxuICAgICAgICAnUkVBRElOR19URU1QRVJBVFVSRV9QQVJBTUVURVJfTkFNRScsXG4gICAgICAgICdSRUFESU5HX01BWF9UT0tFTlNfUEFSQU1FVEVSX05BTUUnLFxuICAgICAgICAnU1lTVEVNX1BST01QVF9TM0tFWV9QQVJBTUVURVJfTkFNRScsXG4gICAgICAgICdVU0VSX1BST01QVF9TM0tFWV9QQVJBTUVURVJfTkFNRScsXG4gICAgICBdO1xuICAgICAgcmV0dXJuIG5hbWUgPyBudWxsIDogbGFiZWxzW2luZGV4XTtcbiAgICB9KVxuICAgIC5maWx0ZXIoQm9vbGVhbik7XG5cbiAgaWYgKG1pc3NpbmdQYXJhbXMubGVuZ3RoID4gMCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBlbnZpcm9ubWVudCB2YXJpYWJsZXM6ICR7bWlzc2luZ1BhcmFtcy5qb2luKCcsICcpfWApO1xuICB9XG5cbiAgLy8gRmV0Y2ggYWxsIFNTTSBwYXJhbWV0ZXJzIGluIHBhcmFsbGVsXG4gIGNvbnN0IHBhcmFtZXRlclByb21pc2VzID0gcGFyYW1ldGVyTmFtZXMubWFwKChuYW1lKSA9PlxuICAgIHNzbUNsaWVudC5zZW5kKFxuICAgICAgbmV3IEdldFBhcmFtZXRlckNvbW1hbmQoe1xuICAgICAgICBOYW1lOiBuYW1lISxcbiAgICAgICAgV2l0aERlY3J5cHRpb246IHRydWUsXG4gICAgICB9KSxcbiAgICApLFxuICApO1xuXG4gIGNvbnN0IHJlc3BvbnNlcyA9IGF3YWl0IFByb21pc2UuYWxsKHBhcmFtZXRlclByb21pc2VzKTtcblxuICAvLyBFeHRyYWN0IFNTTSB2YWx1ZXNcbiAgY29uc3Qgc3NtVmFsdWVzID0gcmVzcG9uc2VzLm1hcCgocmVzcG9uc2UsIGluZGV4KSA9PiB7XG4gICAgaWYgKCFyZXNwb25zZS5QYXJhbWV0ZXI/LlZhbHVlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhcmFtZXRlciAke3BhcmFtZXRlck5hbWVzW2luZGV4XX0gbm90IGZvdW5kIGluIFNTTWApO1xuICAgIH1cbiAgICByZXR1cm4gcmVzcG9uc2UuUGFyYW1ldGVyLlZhbHVlO1xuICB9KTtcblxuICAvLyBMb2cgcGFyYW1ldGVyIG5hbWVzIChub3QgdmFsdWVzKSBmb3IgZGVidWdnaW5nXG4gIGNvbnNvbGUubG9nKCdMb2FkZWQgU1NNIHBhcmFtZXRlcnM6Jywge1xuICAgIG1vZGVsOiBwcm9jZXNzLmVudi5SRUFESU5HX01PREVMX1BBUkFNRVRFUl9OQU1FLFxuICAgIHRlbXBlcmF0dXJlOiBwcm9jZXNzLmVudi5SRUFESU5HX1RFTVBFUkFUVVJFX1BBUkFNRVRFUl9OQU1FLFxuICAgIG1heFRva2VuczogcHJvY2Vzcy5lbnYuUkVBRElOR19NQVhfVE9LRU5TX1BBUkFNRVRFUl9OQU1FLFxuICAgIHN5c3RlbVByb21wdEtleTogc3NtVmFsdWVzWzRdLFxuICAgIHVzZXJQcm9tcHRLZXk6IHNzbVZhbHVlc1s1XSxcbiAgfSk7XG5cbiAgLy8gRmV0Y2ggcHJvbXB0cyBmcm9tIFMzXG4gIGxldCBzeXN0ZW1Qcm9tcHQgPSBGQUxMQkFDS19TWVNURU1fUFJPTVBUO1xuICBsZXQgdXNlclByb21wdFRlbXBsYXRlID0gRkFMTEJBQ0tfVVNFUl9URU1QTEFURTtcbiAgbGV0IHN5c3RlbUVUYWc6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgbGV0IHVzZXJFVGFnOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBbc3lzdGVtUmVzdWx0LCB1c2VyUmVzdWx0XSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIGZldGNoUzNDb250ZW50KGJ1Y2tldE5hbWUsIHNzbVZhbHVlc1s0XSksXG4gICAgICBmZXRjaFMzQ29udGVudChidWNrZXROYW1lLCBzc21WYWx1ZXNbNV0pLFxuICAgIF0pO1xuICAgIFxuICAgIHN5c3RlbVByb21wdCA9IHN5c3RlbVJlc3VsdC5jb250ZW50IHx8IEZBTExCQUNLX1NZU1RFTV9QUk9NUFQ7XG4gICAgdXNlclByb21wdFRlbXBsYXRlID0gdXNlclJlc3VsdC5jb250ZW50IHx8IEZBTExCQUNLX1VTRVJfVEVNUExBVEU7XG4gICAgc3lzdGVtRVRhZyA9IHN5c3RlbVJlc3VsdC5ldGFnO1xuICAgIHVzZXJFVGFnID0gdXNlclJlc3VsdC5ldGFnO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCBwcm9tcHRzIGZyb20gUzMsIHVzaW5nIGZhbGxiYWNrIHByb21wdHM6JywgZXJyb3IpO1xuICB9XG5cbiAgY29uc3QgY29uZmlnOiBPcGVuQUlDb25maWcgPSB7XG4gICAgYXBpS2V5OiBzc21WYWx1ZXNbMF0sXG4gICAgbW9kZWw6IHNzbVZhbHVlc1sxXSxcbiAgICB0ZW1wZXJhdHVyZTogcGFyc2VGbG9hdChzc21WYWx1ZXNbMl0pLFxuICAgIG1heFRva2VuczogcGFyc2VJbnQoc3NtVmFsdWVzWzNdLCAxMCksXG4gICAgc3lzdGVtUHJvbXB0LFxuICAgIHVzZXJQcm9tcHRUZW1wbGF0ZSxcbiAgfTtcblxuICAvLyBDYWNoZSB0aGUgY29uZmlndXJhdGlvblxuICBjYWNoZWRDb25maWcgPSB7XG4gICAgY29uZmlnLFxuICAgIHN5c3RlbVByb21wdEVUYWc6IHN5c3RlbUVUYWcsXG4gICAgdXNlclByb21wdEVUYWc6IHVzZXJFVGFnLFxuICB9O1xuXG4gIHJldHVybiBjb25maWc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFVzZXJQcm9maWxlKHVzZXJJZDogc3RyaW5nKSB7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZHluYW1vRG9jLnNlbmQoXG4gICAgbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5VU0VSX1RBQkxFX05BTUUhLFxuICAgICAgS2V5OiB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgY3JlYXRlZEF0OiAnUFJPRklMRScsXG4gICAgICB9LFxuICAgIH0pLFxuICApO1xuICByZXR1cm4gcmVzcG9uc2UuSXRlbTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0TmF0YWxDaGFydCh1c2VySWQ6IHN0cmluZykge1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGR5bmFtb0RvYy5zZW5kKFxuICAgIG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuTkFUQUxfQ0hBUlRfVEFCTEVfTkFNRSEsXG4gICAgICBLZXk6IHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgfSxcbiAgICB9KSxcbiAgKTtcbiAgcmV0dXJuIHJlc3BvbnNlLkl0ZW07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNhbGxPcGVuQUkocHJvbXB0OiBzdHJpbmcsIGNvbmZpZzogT3BlbkFJQ29uZmlnKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnaHR0cHM6Ly9hcGkub3BlbmFpLmNvbS92MS9jaGF0L2NvbXBsZXRpb25zJywge1xuICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgIGhlYWRlcnM6IHtcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7Y29uZmlnLmFwaUtleX1gLFxuICAgIH0sXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgbW9kZWw6IGNvbmZpZy5tb2RlbCxcbiAgICAgIG1lc3NhZ2VzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICByb2xlOiAnc3lzdGVtJyxcbiAgICAgICAgICBjb250ZW50OiBjb25maWcuc3lzdGVtUHJvbXB0LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcm9sZTogJ3VzZXInLFxuICAgICAgICAgIGNvbnRlbnQ6IHByb21wdCxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICB0ZW1wZXJhdHVyZTogY29uZmlnLnRlbXBlcmF0dXJlLFxuICAgICAgbWF4X3Rva2VuczogY29uZmlnLm1heFRva2VucyxcbiAgICB9KSxcbiAgfSk7XG5cbiAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgIGNvbnN0IGVycm9yID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgIHRocm93IG5ldyBFcnJvcihgT3BlbkFJIEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXN9IC0gJHtlcnJvcn1gKTtcbiAgfVxuXG4gIGNvbnN0IGRhdGEgPSAoYXdhaXQgcmVzcG9uc2UuanNvbigpKSBhcyB7IGNob2ljZXM6IEFycmF5PHsgbWVzc2FnZTogeyBjb250ZW50OiBzdHJpbmcgfSB9PiB9O1xuICByZXR1cm4gZGF0YS5jaG9pY2VzWzBdLm1lc3NhZ2UuY29udGVudDtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgY29uc29sZS5sb2coJ0V2ZW50OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7XG5cbiAgY29uc3QgY29yc0hlYWRlcnMgPSB7XG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsQXV0aG9yaXphdGlvbicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnOiAnUE9TVCxPUFRJT05TJyxcbiAgfTtcblxuICB0cnkge1xuICAgIC8vIEV4dHJhY3QgdXNlcklkIGZyb20gcGF0aFxuICAgIGNvbnN0IHVzZXJJZCA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy51c2VySWQ7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogJ3VzZXJJZCBpcyByZXF1aXJlZCcgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFZlcmlmeSBhdXRoZW50aWNhdGVkIHVzZXIgbWF0Y2hlcyByZXF1ZXN0ZWQgdXNlcklkXG4gICAgY29uc3QgcmVxdWVzdENvbnRleHQgPSBldmVudC5yZXF1ZXN0Q29udGV4dCBhcyB7IGF1dGhvcml6ZXI/OiB7IGNsYWltcz86IHsgc3ViPzogc3RyaW5nIH0gfSB9O1xuICAgIGNvbnN0IGF1dGhlbnRpY2F0ZWRVc2VySWQgPSByZXF1ZXN0Q29udGV4dD8uYXV0aG9yaXplcj8uY2xhaW1zPy5zdWI7XG4gICAgaWYgKGF1dGhlbnRpY2F0ZWRVc2VySWQgIT09IHVzZXJJZCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAzLFxuICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiAnVW5hdXRob3JpemVkIHRvIGdlbmVyYXRlIHJlYWRpbmcgZm9yIHRoaXMgdXNlcicgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIEdldCB1c2VyIHByb2ZpbGUgYW5kIG5hdGFsIGNoYXJ0XG4gICAgY29uc3QgW3VzZXJQcm9maWxlLCBuYXRhbENoYXJ0XSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIGdldFVzZXJQcm9maWxlKHVzZXJJZCksXG4gICAgICBnZXROYXRhbENoYXJ0KHVzZXJJZCksXG4gICAgXSk7XG5cbiAgICBpZiAoIXVzZXJQcm9maWxlKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDQsXG4gICAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6ICdVc2VyIHByb2ZpbGUgbm90IGZvdW5kJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKCFuYXRhbENoYXJ0KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgbWVzc2FnZTogJ05hdGFsIGNoYXJ0IG5vdCBnZW5lcmF0ZWQuIFBsZWFzZSBjb21wbGV0ZSB5b3VyIHByb2ZpbGUgZmlyc3QuJyxcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIEdlbmVyYXRlIHJlYWRpbmcgSUQgYW5kIHRpbWVzdGFtcFxuICAgIGNvbnN0IHJlYWRpbmdJZCA9IHV1aWR2NCgpO1xuICAgIGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcblxuICAgIC8vIENyZWF0ZSB0aGUgcmVhZGluZyByZWNvcmQgd2l0aCBzdGF0dXMgJ1Byb2Nlc3NpbmcnXG4gICAgY29uc3QgcmVhZGluZ1JlY29yZCA9IHtcbiAgICAgIHVzZXJJZCxcbiAgICAgIHJlYWRpbmdJZCxcbiAgICAgIHR5cGU6ICdTb3VsIEJsdWVwcmludCcsXG4gICAgICBzdGF0dXM6ICdQcm9jZXNzaW5nJyxcbiAgICAgIGNyZWF0ZWRBdDogdGltZXN0YW1wLFxuICAgICAgdXBkYXRlZEF0OiB0aW1lc3RhbXAsXG4gICAgfTtcblxuICAgIC8vIFNhdmUgaW5pdGlhbCByZWFkaW5nIHJlY29yZFxuICAgIGF3YWl0IGR5bmFtb0RvYy5zZW5kKFxuICAgICAgbmV3IFB1dENvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlJFQURJTkdTX1RBQkxFX05BTUUhLFxuICAgICAgICBJdGVtOiByZWFkaW5nUmVjb3JkLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBHZXQgT3BlbkFJIGNvbmZpZ3VyYXRpb25cbiAgICAgIGNvbnN0IG9wZW5BSUNvbmZpZyA9IGF3YWl0IGdldE9wZW5BSUNvbmZpZygpO1xuXG4gICAgICAvLyBCdWlsZCB1c2VyIHByb21wdCBmcm9tIHRlbXBsYXRlXG4gICAgICBjb25zdCB1c2VyUHJvbXB0ID0gb3BlbkFJQ29uZmlnLnVzZXJQcm9tcHRUZW1wbGF0ZVxuICAgICAgICAucmVwbGFjZSgne3tiaXJ0aE5hbWV9fScsIHVzZXJQcm9maWxlLnByb2ZpbGU/LmJpcnRoTmFtZSB8fCAnVW5rbm93bicpXG4gICAgICAgIC5yZXBsYWNlKCd7e2JpcnRoRGF0ZX19JywgdXNlclByb2ZpbGUucHJvZmlsZT8uYmlydGhEYXRlIHx8ICdVbmtub3duJylcbiAgICAgICAgLnJlcGxhY2UoJ3t7YmlydGhUaW1lfX0nLCB1c2VyUHJvZmlsZS5wcm9maWxlPy5iaXJ0aFRpbWUgfHwgJ1Vua25vd24nKVxuICAgICAgICAucmVwbGFjZSgne3tiaXJ0aENpdHl9fScsIHVzZXJQcm9maWxlLnByb2ZpbGU/LmJpcnRoQ2l0eSB8fCAnVW5rbm93bicpXG4gICAgICAgIC5yZXBsYWNlKCd7e2JpcnRoU3RhdGV9fScsIHVzZXJQcm9maWxlLnByb2ZpbGU/LmJpcnRoU3RhdGUgfHwgJ1Vua25vd24nKVxuICAgICAgICAucmVwbGFjZSgne3tiaXJ0aENvdW50cnl9fScsIHVzZXJQcm9maWxlLnByb2ZpbGU/LmJpcnRoQ291bnRyeSB8fCAnVW5rbm93bicpXG4gICAgICAgIC5yZXBsYWNlKCd7e25hdGFsQ2hhcnREYXRhfX0nLCBKU09OLnN0cmluZ2lmeShuYXRhbENoYXJ0LCBudWxsLCAyKSk7XG5cbiAgICAgIC8vIENhbGwgT3BlbkFJIEFQSVxuICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IGNhbGxPcGVuQUkodXNlclByb21wdCwgb3BlbkFJQ29uZmlnKTtcblxuICAgICAgLy8gVXBkYXRlIHJlYWRpbmcgd2l0aCBjb250ZW50IGFuZCBzdGF0dXNcbiAgICAgIGNvbnN0IHVwZGF0ZWRSZWFkaW5nID0ge1xuICAgICAgICAuLi5yZWFkaW5nUmVjb3JkLFxuICAgICAgICBjb250ZW50LFxuICAgICAgICBzdGF0dXM6ICdSZWFkeScsXG4gICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgfTtcblxuICAgICAgYXdhaXQgZHluYW1vRG9jLnNlbmQoXG4gICAgICAgIG5ldyBQdXRDb21tYW5kKHtcbiAgICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlJFQURJTkdTX1RBQkxFX05BTUUhLFxuICAgICAgICAgIEl0ZW06IHVwZGF0ZWRSZWFkaW5nLFxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBtZXNzYWdlOiAnUmVhZGluZyBnZW5lcmF0ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgICAgICByZWFkaW5nSWQsXG4gICAgICAgICAgc3RhdHVzOiAnUmVhZHknLFxuICAgICAgICB9KSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGdlbmVyYXRpbmcgcmVhZGluZzonLCBlcnJvcik7XG5cbiAgICAgIC8vIFVwZGF0ZSByZWFkaW5nIHN0YXR1cyB0byBGYWlsZWRcbiAgICAgIGF3YWl0IGR5bmFtb0RvYy5zZW5kKFxuICAgICAgICBuZXcgUHV0Q29tbWFuZCh7XG4gICAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5SRUFESU5HU19UQUJMRV9OQU1FISxcbiAgICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgICAuLi5yZWFkaW5nUmVjb3JkLFxuICAgICAgICAgICAgc3RhdHVzOiAnRmFpbGVkJyxcbiAgICAgICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZ2VuZXJhdGUgcmVhZGluZycsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgIH0pLFxuICAgIH07XG4gIH1cbn07XG4iXX0=