"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_ssm_1 = require("@aws-sdk/client-ssm");
const client_s3_1 = require("@aws-sdk/client-s3");
const uuid_1 = require("uuid");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const dynamoDoc = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const ssmClient = new client_ssm_1.SSMClient({});
const s3Client = new client_s3_1.S3Client({});
// Helper function to create sanitized error response
const createErrorResponse = (error, corsHeaders, context = {}) => {
    // Log detailed error to CloudWatch
    console.error('Error generating reading:', {
        error: error instanceof Error ? error.message : 'Unknown error',
        stack: error instanceof Error ? error.stack : undefined,
        ...context,
        timestamp: new Date().toISOString(),
    });
    // Return generic error message to user
    return {
        statusCode: 500,
        headers: corsHeaders,
        body: JSON.stringify({
            message: "We're sorry, but we couldn't generate your reading at this time. Please try again later.",
        }),
    };
};
// Cache configuration on cold start
let cachedConfig = null;
// Fallback prompts in case S3 fails
const FALLBACK_SYSTEM_PROMPT = 'You are an expert astrologer providing Soul Blueprint readings based on natal charts.';
const FALLBACK_USER_TEMPLATE = `Generate a Soul Blueprint reading for:
Name: {{birthName}}
Birth: {{birthDate}} {{birthTime}}
Location: {{birthCity}}, {{birthState}}, {{birthCountry}}

Natal Chart:
{{natalChartData}}

Provide insights on sun sign, moon sign, rising sign, and life path.`;
async function fetchS3Content(bucket, key) {
    try {
        const response = await s3Client.send(new client_s3_1.GetObjectCommand({
            Bucket: bucket,
            Key: key,
        }));
        const content = (await response.Body?.transformToString()) || '';
        console.log(`Fetched S3 object: ${key}, ETag: ${response.ETag}`);
        return { content, etag: response.ETag };
    }
    catch (error) {
        console.error(`Failed to fetch S3 object ${key}:`, error);
        throw error;
    }
}
async function getOpenAIConfig() {
    // Return cached config if available
    if (cachedConfig) {
        console.log('Using cached configuration');
        return cachedConfig.config;
    }
    console.log('Loading configuration from SSM and S3...');
    const parameterNames = [
        process.env.OPENAI_API_KEY_PARAMETER_NAME,
        process.env.READING_MODEL_PARAMETER_NAME,
        process.env.READING_TEMPERATURE_PARAMETER_NAME,
        process.env.READING_MAX_TOKENS_PARAMETER_NAME,
        process.env.SYSTEM_PROMPT_S3KEY_PARAMETER_NAME,
        process.env.USER_PROMPT_S3KEY_PARAMETER_NAME,
    ];
    const bucketName = process.env.CONFIG_BUCKET_NAME;
    if (!bucketName) {
        throw new Error('CONFIG_BUCKET_NAME environment variable not set');
    }
    // Validate all parameter names are present
    const missingParams = parameterNames
        .map((name, index) => {
        const labels = [
            'OPENAI_API_KEY_PARAMETER_NAME',
            'READING_MODEL_PARAMETER_NAME',
            'READING_TEMPERATURE_PARAMETER_NAME',
            'READING_MAX_TOKENS_PARAMETER_NAME',
            'SYSTEM_PROMPT_S3KEY_PARAMETER_NAME',
            'USER_PROMPT_S3KEY_PARAMETER_NAME',
        ];
        return name ? null : labels[index];
    })
        .filter(Boolean);
    if (missingParams.length > 0) {
        throw new Error(`Missing environment variables: ${missingParams.join(', ')}`);
    }
    // Fetch all SSM parameters in parallel
    const parameterPromises = parameterNames.map((name) => ssmClient.send(new client_ssm_1.GetParameterCommand({
        Name: name,
        WithDecryption: true,
    })));
    const responses = await Promise.all(parameterPromises);
    // Extract SSM values
    const ssmValues = responses.map((response, index) => {
        if (!response.Parameter?.Value) {
            throw new Error(`Parameter ${parameterNames[index]} not found in SSM`);
        }
        return response.Parameter.Value;
    });
    // Log parameter names (not values) for debugging
    console.log('Loaded SSM parameters:', {
        model: process.env.READING_MODEL_PARAMETER_NAME,
        temperature: process.env.READING_TEMPERATURE_PARAMETER_NAME,
        maxTokens: process.env.READING_MAX_TOKENS_PARAMETER_NAME,
        systemPromptKey: ssmValues[4],
        userPromptKey: ssmValues[5],
    });
    // Fetch prompts from S3
    let systemPrompt = FALLBACK_SYSTEM_PROMPT;
    let userPromptTemplate = FALLBACK_USER_TEMPLATE;
    let systemETag;
    let userETag;
    try {
        const [systemResult, userResult] = await Promise.all([
            fetchS3Content(bucketName, ssmValues[4]),
            fetchS3Content(bucketName, ssmValues[5]),
        ]);
        systemPrompt = systemResult.content || FALLBACK_SYSTEM_PROMPT;
        userPromptTemplate = userResult.content || FALLBACK_USER_TEMPLATE;
        systemETag = systemResult.etag;
        userETag = userResult.etag;
    }
    catch (error) {
        console.error('Failed to fetch prompts from S3, using fallback prompts:', error);
    }
    const config = {
        apiKey: ssmValues[0],
        model: ssmValues[1],
        temperature: parseFloat(ssmValues[2]),
        maxTokens: parseInt(ssmValues[3], 10),
        systemPrompt,
        userPromptTemplate,
    };
    // Cache the configuration
    cachedConfig = {
        config,
        systemPromptETag: systemETag,
        userPromptETag: userETag,
    };
    return config;
}
async function getUserProfile(userId) {
    const response = await dynamoDoc.send(new lib_dynamodb_1.GetCommand({
        TableName: process.env.USER_TABLE_NAME,
        Key: {
            userId,
            createdAt: 'PROFILE',
        },
    }));
    return response.Item;
}
async function getNatalChart(userId) {
    const response = await dynamoDoc.send(new lib_dynamodb_1.GetCommand({
        TableName: process.env.NATAL_CHART_TABLE_NAME,
        Key: {
            userId,
        },
    }));
    return response.Item;
}
async function callOpenAI(prompt, config) {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${config.apiKey}`,
        },
        body: JSON.stringify({
            model: config.model,
            messages: [
                {
                    role: 'system',
                    content: config.systemPrompt,
                },
                {
                    role: 'user',
                    content: prompt,
                },
            ],
            temperature: config.temperature,
            max_tokens: config.maxTokens,
        }),
    });
    if (!response.ok) {
        const error = await response.text();
        throw new Error(`OpenAI API error: ${response.status} - ${error}`);
    }
    const data = (await response.json());
    return data.choices[0].message.content;
}
const handler = async (event) => {
    console.log('Event:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'POST,OPTIONS',
    };
    try {
        // Extract userId from path
        const userId = event.pathParameters?.userId;
        if (!userId) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({ message: 'userId is required' }),
            };
        }
        // Verify authenticated user matches requested userId
        const requestContext = event.requestContext;
        const authenticatedUserId = requestContext?.authorizer?.claims?.sub;
        if (authenticatedUserId !== userId) {
            return {
                statusCode: 403,
                headers: corsHeaders,
                body: JSON.stringify({ message: 'Unauthorized to generate reading for this user' }),
            };
        }
        // Get user profile and natal chart
        const [userProfile, natalChart] = await Promise.all([
            getUserProfile(userId),
            getNatalChart(userId),
        ]);
        if (!userProfile) {
            return {
                statusCode: 404,
                headers: corsHeaders,
                body: JSON.stringify({ message: 'User profile not found' }),
            };
        }
        if (!natalChart) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({
                    message: 'Natal chart not generated. Please complete your profile first.',
                }),
            };
        }
        // Generate reading ID and timestamp
        const readingId = (0, uuid_1.v4)();
        const timestamp = new Date().toISOString();
        // Create the reading record with status 'Processing'
        const readingRecord = {
            userId,
            readingId,
            type: 'Soul Blueprint',
            status: 'Processing',
            createdAt: timestamp,
            updatedAt: timestamp,
        };
        // Save initial reading record
        await dynamoDoc.send(new lib_dynamodb_1.PutCommand({
            TableName: process.env.READINGS_TABLE_NAME,
            Item: readingRecord,
        }));
        try {
            // Get OpenAI configuration
            const openAIConfig = await getOpenAIConfig();
            // Build user prompt from template
            const userPrompt = openAIConfig.userPromptTemplate
                .replace('{{birthName}}', userProfile.profile?.birthName || 'Unknown')
                .replace('{{birthDate}}', userProfile.profile?.birthDate || 'Unknown')
                .replace('{{birthTime}}', userProfile.profile?.birthTime || 'Unknown')
                .replace('{{birthCity}}', userProfile.profile?.birthCity || 'Unknown')
                .replace('{{birthState}}', userProfile.profile?.birthState || 'Unknown')
                .replace('{{birthCountry}}', userProfile.profile?.birthCountry || 'Unknown')
                .replace('{{natalChartData}}', JSON.stringify(natalChart, null, 2));
            // Call OpenAI API
            const content = await callOpenAI(userPrompt, openAIConfig);
            // Update reading with content and status
            const updatedReading = {
                ...readingRecord,
                content,
                status: 'Ready',
                updatedAt: new Date().toISOString(),
            };
            await dynamoDoc.send(new lib_dynamodb_1.PutCommand({
                TableName: process.env.READINGS_TABLE_NAME,
                Item: updatedReading,
            }));
            return {
                statusCode: 200,
                headers: corsHeaders,
                body: JSON.stringify({
                    message: 'Reading generated successfully',
                    readingId,
                    status: 'Ready',
                }),
            };
        }
        catch (error) {
            // Log detailed error for debugging
            console.error('Error during reading generation:', {
                error: error instanceof Error ? error.message : 'Unknown error',
                stack: error instanceof Error ? error.stack : undefined,
                userId,
                readingId,
                timestamp: new Date().toISOString(),
            });
            // Update reading status to Failed with sanitized error
            await dynamoDoc.send(new lib_dynamodb_1.PutCommand({
                TableName: process.env.READINGS_TABLE_NAME,
                Item: {
                    ...readingRecord,
                    status: 'Failed',
                    error: 'GENERATION_FAILED', // Sanitized error indicator
                    updatedAt: new Date().toISOString(),
                },
            }));
            throw error;
        }
    }
    catch (error) {
        // Use helper function to create sanitized error response
        return createErrorResponse(error, corsHeaders, {
            userId: event.pathParameters?.userId,
            path: event.path,
            method: event.httpMethod,
        });
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUtcmVhZGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdlbmVyYXRlLXJlYWRpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUF1RjtBQUN2RixvREFBcUU7QUFDckUsa0RBQWdFO0FBQ2hFLCtCQUFvQztBQUVwQyxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQzVELE1BQU0sU0FBUyxHQUFHLElBQUksc0JBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNwQyxNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFbEMscURBQXFEO0FBQ3JELE1BQU0sbUJBQW1CLEdBQUcsQ0FDMUIsS0FBYyxFQUNkLFdBQW1DLEVBQ25DLFVBQW1DLEVBQUUsRUFDZCxFQUFFO0lBQ3pCLG1DQUFtQztJQUNuQyxPQUFPLENBQUMsS0FBSyxDQUFDLDJCQUEyQixFQUFFO1FBQ3pDLEtBQUssRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO1FBQy9ELEtBQUssRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTO1FBQ3ZELEdBQUcsT0FBTztRQUNWLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtLQUNwQyxDQUFDLENBQUM7SUFFSCx1Q0FBdUM7SUFDdkMsT0FBTztRQUNMLFVBQVUsRUFBRSxHQUFHO1FBQ2YsT0FBTyxFQUFFLFdBQVc7UUFDcEIsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDbkIsT0FBTyxFQUNMLDBGQUEwRjtTQUM3RixD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QkFDcEM7YUFDRixDQUFDLENBQ0gsQ0FBQztZQUVGLE1BQU0sS0FBSyxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YseURBQXlEO1FBQ3pELE9BQU8sbUJBQW1CLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRTtZQUM3QyxNQUFNLEVBQUUsS0FBSyxDQUFDLGNBQWMsRUFBRSxNQUFNO1lBQ3BDLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSTtZQUNoQixNQUFNLEVBQUUsS0FBSyxDQUFDLFVBQVU7U0FDekIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztBQUNILENBQUMsQ0FBQztBQXZKVyxRQUFBLE9BQU8sV0F1SmxCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUHV0Q29tbWFuZCwgR2V0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBTU01DbGllbnQsIEdldFBhcmFtZXRlckNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtc3NtJztcbmltcG9ydCB7IFMzQ2xpZW50LCBHZXRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuXG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZHluYW1vRG9jID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGR5bmFtb0NsaWVudCk7XG5jb25zdCBzc21DbGllbnQgPSBuZXcgU1NNQ2xpZW50KHt9KTtcbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHt9KTtcblxuLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNyZWF0ZSBzYW5pdGl6ZWQgZXJyb3IgcmVzcG9uc2VcbmNvbnN0IGNyZWF0ZUVycm9yUmVzcG9uc2UgPSAoXG4gIGVycm9yOiB1bmtub3duLFxuICBjb3JzSGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPixcbiAgY29udGV4dDogUmVjb3JkPHN0cmluZywgdW5rbm93bj4gPSB7fSxcbik6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9PiB7XG4gIC8vIExvZyBkZXRhaWxlZCBlcnJvciB0byBDbG91ZFdhdGNoXG4gIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGdlbmVyYXRpbmcgcmVhZGluZzonLCB7XG4gICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIHN0YWNrOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3Iuc3RhY2sgOiB1bmRlZmluZWQsXG4gICAgLi4uY29udGV4dCxcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgfSk7XG5cbiAgLy8gUmV0dXJuIGdlbmVyaWMgZXJyb3IgbWVzc2FnZSB0byB1c2VyXG4gIHJldHVybiB7XG4gICAgc3RhdHVzQ29kZTogNTAwLFxuICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIG1lc3NhZ2U6XG4gICAgICAgIFwiV2UncmUgc29ycnksIGJ1dCB3ZSBjb3VsZG4ndCBnZW5lcmF0ZSB5b3VyIHJlYWRpbmcgYXQgdGhpcyB0aW1lLiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLlwiLFxuICAgIH0pLFxuICB9O1xufTtcblxuaW50ZXJmYWNlIE9wZW5BSUNvbmZpZyB7XG4gIGFwaUtleTogc3RyaW5nO1xuICBtb2RlbDogc3RyaW5nO1xuICB0ZW1wZXJhdHVyZTogbnVtYmVyO1xuICBtYXhUb2tlbnM6IG51bWJlcjtcbiAgc3lzdGVtUHJvbXB0OiBzdHJpbmc7XG4gIHVzZXJQcm9tcHRUZW1wbGF0ZTogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgQ2FjaGVkQ29uZmlnIHtcbiAgY29uZmlnOiBPcGVuQUlDb25maWc7XG4gIHN5c3RlbVByb21wdEVUYWc/OiBzdHJpbmc7XG4gIHVzZXJQcm9tcHRFVGFnPzogc3RyaW5nO1xufVxuXG4vLyBDYWNoZSBjb25maWd1cmF0aW9uIG9uIGNvbGQgc3RhcnRcbmxldCBjYWNoZWRDb25maWc6IENhY2hlZENvbmZpZyB8IG51bGwgPSBudWxsO1xuXG4vLyBGYWxsYmFjayBwcm9tcHRzIGluIGNhc2UgUzMgZmFpbHNcbmNvbnN0IEZBTExCQUNLX1NZU1RFTV9QUk9NUFQgPVxuICAnWW91IGFyZSBhbiBleHBlcnQgYXN0cm9sb2dlciBwcm92aWRpbmcgU291bCBCbHVlcHJpbnQgcmVhZGluZ3MgYmFzZWQgb24gbmF0YWwgY2hhcnRzLic7XG5jb25zdCBGQUxMQkFDS19VU0VSX1RFTVBMQVRFID0gYEdlbmVyYXRlIGEgU291bCBCbHVlcHJpbnQgcmVhZGluZyBmb3I6XG5OYW1lOiB7e2JpcnRoTmFtZX19XG5CaXJ0aDoge3tiaXJ0aERhdGV9fSB7e2JpcnRoVGltZX19XG5Mb2NhdGlvbjoge3tiaXJ0aENpdHl9fSwge3tiaXJ0aFN0YXRlfX0sIHt7YmlydGhDb3VudHJ5fX1cblxuTmF0YWwgQ2hhcnQ6XG57e25hdGFsQ2hhcnREYXRhfX1cblxuUHJvdmlkZSBpbnNpZ2h0cyBvbiBzdW4gc2lnbiwgbW9vbiBzaWduLCByaXNpbmcgc2lnbiwgYW5kIGxpZmUgcGF0aC5gO1xuXG5hc3luYyBmdW5jdGlvbiBmZXRjaFMzQ29udGVudChcbiAgYnVja2V0OiBzdHJpbmcsXG4gIGtleTogc3RyaW5nLFxuKTogUHJvbWlzZTx7IGNvbnRlbnQ6IHN0cmluZzsgZXRhZz86IHN0cmluZyB9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzM0NsaWVudC5zZW5kKFxuICAgICAgbmV3IEdldE9iamVjdENvbW1hbmQoe1xuICAgICAgICBCdWNrZXQ6IGJ1Y2tldCxcbiAgICAgICAgS2V5OiBrZXksXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgY29uc3QgY29udGVudCA9IChhd2FpdCByZXNwb25zZS5Cb2R5Py50cmFuc2Zvcm1Ub1N0cmluZygpKSB8fCAnJztcbiAgICBjb25zb2xlLmxvZyhgRmV0Y2hlZCBTMyBvYmplY3Q6ICR7a2V5fSwgRVRhZzogJHtyZXNwb25zZS5FVGFnfWApO1xuXG4gICAgcmV0dXJuIHsgY29udGVudCwgZXRhZzogcmVzcG9uc2UuRVRhZyB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBmZXRjaCBTMyBvYmplY3QgJHtrZXl9OmAsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRPcGVuQUlDb25maWcoKTogUHJvbWlzZTxPcGVuQUlDb25maWc+IHtcbiAgLy8gUmV0dXJuIGNhY2hlZCBjb25maWcgaWYgYXZhaWxhYmxlXG4gIGlmIChjYWNoZWRDb25maWcpIHtcbiAgICBjb25zb2xlLmxvZygnVXNpbmcgY2FjaGVkIGNvbmZpZ3VyYXRpb24nKTtcbiAgICByZXR1cm4gY2FjaGVkQ29uZmlnLmNvbmZpZztcbiAgfVxuXG4gIGNvbnNvbGUubG9nKCdMb2FkaW5nIGNvbmZpZ3VyYXRpb24gZnJvbSBTU00gYW5kIFMzLi4uJyk7XG5cbiAgY29uc3QgcGFyYW1ldGVyTmFtZXMgPSBbXG4gICAgcHJvY2Vzcy5lbnYuT1BFTkFJX0FQSV9LRVlfUEFSQU1FVEVSX05BTUUsXG4gICAgcHJvY2Vzcy5lbnYuUkVBRElOR19NT0RFTF9QQVJBTUVURVJfTkFNRSxcbiAgICBwcm9jZXNzLmVudi5SRUFESU5HX1RFTVBFUkFUVVJFX1BBUkFNRVRFUl9OQU1FLFxuICAgIHByb2Nlc3MuZW52LlJFQURJTkdfTUFYX1RPS0VOU19QQVJBTUVURVJfTkFNRSxcbiAgICBwcm9jZXNzLmVudi5TWVNURU1fUFJPTVBUX1MzS0VZX1BBUkFNRVRFUl9OQU1FLFxuICAgIHByb2Nlc3MuZW52LlVTRVJfUFJPTVBUX1MzS0VZX1BBUkFNRVRFUl9OQU1FLFxuICBdO1xuXG4gIGNvbnN0IGJ1Y2tldE5hbWUgPSBwcm9jZXNzLmVudi5DT05GSUdfQlVDS0VUX05BTUU7XG5cbiAgaWYgKCFidWNrZXROYW1lKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDT05GSUdfQlVDS0VUX05BTUUgZW52aXJvbm1lbnQgdmFyaWFibGUgbm90IHNldCcpO1xuICB9XG5cbiAgLy8gVmFsaWRhdGUgYWxsIHBhcmFtZXRlciBuYW1lcyBhcmUgcHJlc2VudFxuICBjb25zdCBtaXNzaW5nUGFyYW1zID0gcGFyYW1ldGVyTmFtZXNcbiAgICAubWFwKChuYW1lLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgbGFiZWxzID0gW1xuICAgICAgICAnT1BFTkFJX0FQSV9LRVlfUEFSQU1FVEVSX05BTUUnLFxuICAgICAgICAnUkVBRElOR19NT0RFTF9QQVJBTUVURVJfTkFNRScsXG4gICAgICAgICdSRUFESU5HX1RFTVBFUkFUVVJFX1BBUkFNRVRFUl9OQU1FJyxcbiAgICAgICAgJ1JFQURJTkdfTUFYX1RPS0VOU19QQVJBTUVURVJfTkFNRScsXG4gICAgICAgICdTWVNURU1fUFJPTVBUX1MzS0VZX1BBUkFNRVRFUl9OQU1FJyxcbiAgICAgICAgJ1VTRVJfUFJPTVBUX1MzS0VZX1BBUkFNRVRFUl9OQU1FJyxcbiAgICAgIF07XG4gICAgICByZXR1cm4gbmFtZSA/IG51bGwgOiBsYWJlbHNbaW5kZXhdO1xuICAgIH0pXG4gICAgLmZpbHRlcihCb29sZWFuKTtcblxuICBpZiAobWlzc2luZ1BhcmFtcy5sZW5ndGggPiAwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIGVudmlyb25tZW50IHZhcmlhYmxlczogJHttaXNzaW5nUGFyYW1zLmpvaW4oJywgJyl9YCk7XG4gIH1cblxuICAvLyBGZXRjaCBhbGwgU1NNIHBhcmFtZXRlcnMgaW4gcGFyYWxsZWxcbiAgY29uc3QgcGFyYW1ldGVyUHJvbWlzZXMgPSBwYXJhbWV0ZXJOYW1lcy5tYXAoKG5hbWUpID0+XG4gICAgc3NtQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgR2V0UGFyYW1ldGVyQ29tbWFuZCh7XG4gICAgICAgIE5hbWU6IG5hbWUhLFxuICAgICAgICBXaXRoRGVjcnlwdGlvbjogdHJ1ZSxcbiAgICAgIH0pLFxuICAgICksXG4gICk7XG5cbiAgY29uc3QgcmVzcG9uc2VzID0gYXdhaXQgUHJvbWlzZS5hbGwocGFyYW1ldGVyUHJvbWlzZXMpO1xuXG4gIC8vIEV4dHJhY3QgU1NNIHZhbHVlc1xuICBjb25zdCBzc21WYWx1ZXMgPSByZXNwb25zZXMubWFwKChyZXNwb25zZSwgaW5kZXgpID0+IHtcbiAgICBpZiAoIXJlc3BvbnNlLlBhcmFtZXRlcj8uVmFsdWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUGFyYW1ldGVyICR7cGFyYW1ldGVyTmFtZXNbaW5kZXhdfSBub3QgZm91bmQgaW4gU1NNYCk7XG4gICAgfVxuICAgIHJldHVybiByZXNwb25zZS5QYXJhbWV0ZXIuVmFsdWU7XG4gIH0pO1xuXG4gIC8vIExvZyBwYXJhbWV0ZXIgbmFtZXMgKG5vdCB2YWx1ZXMpIGZvciBkZWJ1Z2dpbmdcbiAgY29uc29sZS5sb2coJ0xvYWRlZCBTU00gcGFyYW1ldGVyczonLCB7XG4gICAgbW9kZWw6IHByb2Nlc3MuZW52LlJFQURJTkdfTU9ERUxfUEFSQU1FVEVSX05BTUUsXG4gICAgdGVtcGVyYXR1cmU6IHByb2Nlc3MuZW52LlJFQURJTkdfVEVNUEVSQVRVUkVfUEFSQU1FVEVSX05BTUUsXG4gICAgbWF4VG9rZW5zOiBwcm9jZXNzLmVudi5SRUFESU5HX01BWF9UT0tFTlNfUEFSQU1FVEVSX05BTUUsXG4gICAgc3lzdGVtUHJvbXB0S2V5OiBzc21WYWx1ZXNbNF0sXG4gICAgdXNlclByb21wdEtleTogc3NtVmFsdWVzWzVdLFxuICB9KTtcblxuICAvLyBGZXRjaCBwcm9tcHRzIGZyb20gUzNcbiAgbGV0IHN5c3RlbVByb21wdCA9IEZBTExCQUNLX1NZU1RFTV9QUk9NUFQ7XG4gIGxldCB1c2VyUHJvbXB0VGVtcGxhdGUgPSBGQUxMQkFDS19VU0VSX1RFTVBMQVRFO1xuICBsZXQgc3lzdGVtRVRhZzogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBsZXQgdXNlckVUYWc6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICB0cnkge1xuICAgIGNvbnN0IFtzeXN0ZW1SZXN1bHQsIHVzZXJSZXN1bHRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgZmV0Y2hTM0NvbnRlbnQoYnVja2V0TmFtZSwgc3NtVmFsdWVzWzRdKSxcbiAgICAgIGZldGNoUzNDb250ZW50KGJ1Y2tldE5hbWUsIHNzbVZhbHVlc1s1XSksXG4gICAgXSk7XG5cbiAgICBzeXN0ZW1Qcm9tcHQgPSBzeXN0ZW1SZXN1bHQuY29udGVudCB8fCBGQUxMQkFDS19TWVNURU1fUFJPTVBUO1xuICAgIHVzZXJQcm9tcHRUZW1wbGF0ZSA9IHVzZXJSZXN1bHQuY29udGVudCB8fCBGQUxMQkFDS19VU0VSX1RFTVBMQVRFO1xuICAgIHN5c3RlbUVUYWcgPSBzeXN0ZW1SZXN1bHQuZXRhZztcbiAgICB1c2VyRVRhZyA9IHVzZXJSZXN1bHQuZXRhZztcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gZmV0Y2ggcHJvbXB0cyBmcm9tIFMzLCB1c2luZyBmYWxsYmFjayBwcm9tcHRzOicsIGVycm9yKTtcbiAgfVxuXG4gIGNvbnN0IGNvbmZpZzogT3BlbkFJQ29uZmlnID0ge1xuICAgIGFwaUtleTogc3NtVmFsdWVzWzBdLFxuICAgIG1vZGVsOiBzc21WYWx1ZXNbMV0sXG4gICAgdGVtcGVyYXR1cmU6IHBhcnNlRmxvYXQoc3NtVmFsdWVzWzJdKSxcbiAgICBtYXhUb2tlbnM6IHBhcnNlSW50KHNzbVZhbHVlc1szXSwgMTApLFxuICAgIHN5c3RlbVByb21wdCxcbiAgICB1c2VyUHJvbXB0VGVtcGxhdGUsXG4gIH07XG5cbiAgLy8gQ2FjaGUgdGhlIGNvbmZpZ3VyYXRpb25cbiAgY2FjaGVkQ29uZmlnID0ge1xuICAgIGNvbmZpZyxcbiAgICBzeXN0ZW1Qcm9tcHRFVGFnOiBzeXN0ZW1FVGFnLFxuICAgIHVzZXJQcm9tcHRFVGFnOiB1c2VyRVRhZyxcbiAgfTtcblxuICByZXR1cm4gY29uZmlnO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRVc2VyUHJvZmlsZSh1c2VySWQ6IHN0cmluZykge1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGR5bmFtb0RvYy5zZW5kKFxuICAgIG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuVVNFUl9UQUJMRV9OQU1FISxcbiAgICAgIEtleToge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIGNyZWF0ZWRBdDogJ1BST0ZJTEUnLFxuICAgICAgfSxcbiAgICB9KSxcbiAgKTtcbiAgcmV0dXJuIHJlc3BvbnNlLkl0ZW07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE5hdGFsQ2hhcnQodXNlcklkOiBzdHJpbmcpIHtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkeW5hbW9Eb2Muc2VuZChcbiAgICBuZXcgR2V0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52Lk5BVEFMX0NIQVJUX1RBQkxFX05BTUUhLFxuICAgICAgS2V5OiB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH0sXG4gICAgfSksXG4gICk7XG4gIHJldHVybiByZXNwb25zZS5JdGVtO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjYWxsT3BlbkFJKHByb21wdDogc3RyaW5nLCBjb25maWc6IE9wZW5BSUNvbmZpZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goJ2h0dHBzOi8vYXBpLm9wZW5haS5jb20vdjEvY2hhdC9jb21wbGV0aW9ucycsIHtcbiAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICBoZWFkZXJzOiB7XG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke2NvbmZpZy5hcGlLZXl9YCxcbiAgICB9LFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIG1vZGVsOiBjb25maWcubW9kZWwsXG4gICAgICBtZXNzYWdlczogW1xuICAgICAgICB7XG4gICAgICAgICAgcm9sZTogJ3N5c3RlbScsXG4gICAgICAgICAgY29udGVudDogY29uZmlnLnN5c3RlbVByb21wdCxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHJvbGU6ICd1c2VyJyxcbiAgICAgICAgICBjb250ZW50OiBwcm9tcHQsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgdGVtcGVyYXR1cmU6IGNvbmZpZy50ZW1wZXJhdHVyZSxcbiAgICAgIG1heF90b2tlbnM6IGNvbmZpZy5tYXhUb2tlbnMsXG4gICAgfSksXG4gIH0pO1xuXG4gIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICBjb25zdCBlcnJvciA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE9wZW5BSSBBUEkgZXJyb3I6ICR7cmVzcG9uc2Uuc3RhdHVzfSAtICR7ZXJyb3J9YCk7XG4gIH1cblxuICBjb25zdCBkYXRhID0gKGF3YWl0IHJlc3BvbnNlLmpzb24oKSkgYXMgeyBjaG9pY2VzOiBBcnJheTx7IG1lc3NhZ2U6IHsgY29udGVudDogc3RyaW5nIH0gfT4gfTtcbiAgcmV0dXJuIGRhdGEuY2hvaWNlc1swXS5tZXNzYWdlLmNvbnRlbnQ7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIGNvbnNvbGUubG9nKCdFdmVudDonLCBKU09OLnN0cmluZ2lmeShldmVudCkpO1xuXG4gIGNvbnN0IGNvcnNIZWFkZXJzID0ge1xuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ1BPU1QsT1BUSU9OUycsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICAvLyBFeHRyYWN0IHVzZXJJZCBmcm9tIHBhdGhcbiAgICBjb25zdCB1c2VySWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8udXNlcklkO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6ICd1c2VySWQgaXMgcmVxdWlyZWQnIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZnkgYXV0aGVudGljYXRlZCB1c2VyIG1hdGNoZXMgcmVxdWVzdGVkIHVzZXJJZFxuICAgIGNvbnN0IHJlcXVlc3RDb250ZXh0ID0gZXZlbnQucmVxdWVzdENvbnRleHQgYXMgeyBhdXRob3JpemVyPzogeyBjbGFpbXM/OiB7IHN1Yj86IHN0cmluZyB9IH0gfTtcbiAgICBjb25zdCBhdXRoZW50aWNhdGVkVXNlcklkID0gcmVxdWVzdENvbnRleHQ/LmF1dGhvcml6ZXI/LmNsYWltcz8uc3ViO1xuICAgIGlmIChhdXRoZW50aWNhdGVkVXNlcklkICE9PSB1c2VySWQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMyxcbiAgICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogJ1VuYXV0aG9yaXplZCB0byBnZW5lcmF0ZSByZWFkaW5nIGZvciB0aGlzIHVzZXInIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBHZXQgdXNlciBwcm9maWxlIGFuZCBuYXRhbCBjaGFydFxuICAgIGNvbnN0IFt1c2VyUHJvZmlsZSwgbmF0YWxDaGFydF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICBnZXRVc2VyUHJvZmlsZSh1c2VySWQpLFxuICAgICAgZ2V0TmF0YWxDaGFydCh1c2VySWQpLFxuICAgIF0pO1xuXG4gICAgaWYgKCF1c2VyUHJvZmlsZSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDA0LFxuICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiAnVXNlciBwcm9maWxlIG5vdCBmb3VuZCcgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmICghbmF0YWxDaGFydCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIG1lc3NhZ2U6ICdOYXRhbCBjaGFydCBub3QgZ2VuZXJhdGVkLiBQbGVhc2UgY29tcGxldGUgeW91ciBwcm9maWxlIGZpcnN0LicsXG4gICAgICAgIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBHZW5lcmF0ZSByZWFkaW5nIElEIGFuZCB0aW1lc3RhbXBcbiAgICBjb25zdCByZWFkaW5nSWQgPSB1dWlkdjQoKTtcbiAgICBjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG5cbiAgICAvLyBDcmVhdGUgdGhlIHJlYWRpbmcgcmVjb3JkIHdpdGggc3RhdHVzICdQcm9jZXNzaW5nJ1xuICAgIGNvbnN0IHJlYWRpbmdSZWNvcmQgPSB7XG4gICAgICB1c2VySWQsXG4gICAgICByZWFkaW5nSWQsXG4gICAgICB0eXBlOiAnU291bCBCbHVlcHJpbnQnLFxuICAgICAgc3RhdHVzOiAnUHJvY2Vzc2luZycsXG4gICAgICBjcmVhdGVkQXQ6IHRpbWVzdGFtcCxcbiAgICAgIHVwZGF0ZWRBdDogdGltZXN0YW1wLFxuICAgIH07XG5cbiAgICAvLyBTYXZlIGluaXRpYWwgcmVhZGluZyByZWNvcmRcbiAgICBhd2FpdCBkeW5hbW9Eb2Muc2VuZChcbiAgICAgIG5ldyBQdXRDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5SRUFESU5HU19UQUJMRV9OQU1FISxcbiAgICAgICAgSXRlbTogcmVhZGluZ1JlY29yZCxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gR2V0IE9wZW5BSSBjb25maWd1cmF0aW9uXG4gICAgICBjb25zdCBvcGVuQUlDb25maWcgPSBhd2FpdCBnZXRPcGVuQUlDb25maWcoKTtcblxuICAgICAgLy8gQnVpbGQgdXNlciBwcm9tcHQgZnJvbSB0ZW1wbGF0ZVxuICAgICAgY29uc3QgdXNlclByb21wdCA9IG9wZW5BSUNvbmZpZy51c2VyUHJvbXB0VGVtcGxhdGVcbiAgICAgICAgLnJlcGxhY2UoJ3t7YmlydGhOYW1lfX0nLCB1c2VyUHJvZmlsZS5wcm9maWxlPy5iaXJ0aE5hbWUgfHwgJ1Vua25vd24nKVxuICAgICAgICAucmVwbGFjZSgne3tiaXJ0aERhdGV9fScsIHVzZXJQcm9maWxlLnByb2ZpbGU/LmJpcnRoRGF0ZSB8fCAnVW5rbm93bicpXG4gICAgICAgIC5yZXBsYWNlKCd7e2JpcnRoVGltZX19JywgdXNlclByb2ZpbGUucHJvZmlsZT8uYmlydGhUaW1lIHx8ICdVbmtub3duJylcbiAgICAgICAgLnJlcGxhY2UoJ3t7YmlydGhDaXR5fX0nLCB1c2VyUHJvZmlsZS5wcm9maWxlPy5iaXJ0aENpdHkgfHwgJ1Vua25vd24nKVxuICAgICAgICAucmVwbGFjZSgne3tiaXJ0aFN0YXRlfX0nLCB1c2VyUHJvZmlsZS5wcm9maWxlPy5iaXJ0aFN0YXRlIHx8ICdVbmtub3duJylcbiAgICAgICAgLnJlcGxhY2UoJ3t7YmlydGhDb3VudHJ5fX0nLCB1c2VyUHJvZmlsZS5wcm9maWxlPy5iaXJ0aENvdW50cnkgfHwgJ1Vua25vd24nKVxuICAgICAgICAucmVwbGFjZSgne3tuYXRhbENoYXJ0RGF0YX19JywgSlNPTi5zdHJpbmdpZnkobmF0YWxDaGFydCwgbnVsbCwgMikpO1xuXG4gICAgICAvLyBDYWxsIE9wZW5BSSBBUElcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCBjYWxsT3BlbkFJKHVzZXJQcm9tcHQsIG9wZW5BSUNvbmZpZyk7XG5cbiAgICAgIC8vIFVwZGF0ZSByZWFkaW5nIHdpdGggY29udGVudCBhbmQgc3RhdHVzXG4gICAgICBjb25zdCB1cGRhdGVkUmVhZGluZyA9IHtcbiAgICAgICAgLi4ucmVhZGluZ1JlY29yZCxcbiAgICAgICAgY29udGVudCxcbiAgICAgICAgc3RhdHVzOiAnUmVhZHknLFxuICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgIH07XG5cbiAgICAgIGF3YWl0IGR5bmFtb0RvYy5zZW5kKFxuICAgICAgICBuZXcgUHV0Q29tbWFuZCh7XG4gICAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5SRUFESU5HU19UQUJMRV9OQU1FISxcbiAgICAgICAgICBJdGVtOiB1cGRhdGVkUmVhZGluZyxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgbWVzc2FnZTogJ1JlYWRpbmcgZ2VuZXJhdGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgICAgICAgcmVhZGluZ0lkLFxuICAgICAgICAgIHN0YXR1czogJ1JlYWR5JyxcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBMb2cgZGV0YWlsZWQgZXJyb3IgZm9yIGRlYnVnZ2luZ1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZHVyaW5nIHJlYWRpbmcgZ2VuZXJhdGlvbjonLCB7XG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgICAgc3RhY2s6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgICByZWFkaW5nSWQsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFVwZGF0ZSByZWFkaW5nIHN0YXR1cyB0byBGYWlsZWQgd2l0aCBzYW5pdGl6ZWQgZXJyb3JcbiAgICAgIGF3YWl0IGR5bmFtb0RvYy5zZW5kKFxuICAgICAgICBuZXcgUHV0Q29tbWFuZCh7XG4gICAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5SRUFESU5HU19UQUJMRV9OQU1FISxcbiAgICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgICAuLi5yZWFkaW5nUmVjb3JkLFxuICAgICAgICAgICAgc3RhdHVzOiAnRmFpbGVkJyxcbiAgICAgICAgICAgIGVycm9yOiAnR0VORVJBVElPTl9GQUlMRUQnLCAvLyBTYW5pdGl6ZWQgZXJyb3IgaW5kaWNhdG9yXG4gICAgICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAvLyBVc2UgaGVscGVyIGZ1bmN0aW9uIHRvIGNyZWF0ZSBzYW5pdGl6ZWQgZXJyb3IgcmVzcG9uc2VcbiAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZShlcnJvciwgY29yc0hlYWRlcnMsIHtcbiAgICAgIHVzZXJJZDogZXZlbnQucGF0aFBhcmFtZXRlcnM/LnVzZXJJZCxcbiAgICAgIHBhdGg6IGV2ZW50LnBhdGgsXG4gICAgICBtZXRob2Q6IGV2ZW50Lmh0dHBNZXRob2QsXG4gICAgfSk7XG4gIH1cbn07XG4iXX0=