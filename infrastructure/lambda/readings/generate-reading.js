"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_ssm_1 = require("@aws-sdk/client-ssm");
const uuid_1 = require("uuid");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const dynamoDoc = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const ssmClient = new client_ssm_1.SSMClient({});
async function getOpenAIConfig() {
    const parameterNames = [
        process.env.OPENAI_API_KEY_PARAMETER_NAME,
        process.env.OPENAI_MODEL_PARAMETER_NAME,
        process.env.OPENAI_TEMPERATURE_PARAMETER_NAME,
        process.env.OPENAI_MAX_TOKENS_PARAMETER_NAME,
        process.env.OPENAI_SYSTEM_PROMPT_PARAMETER_NAME,
        process.env.OPENAI_USER_PROMPT_TEMPLATE_PARAMETER_NAME,
    ];
    // Validate all parameter names are present
    const missingParams = parameterNames
        .map((name, index) => {
        const labels = [
            'OPENAI_API_KEY_PARAMETER_NAME',
            'OPENAI_MODEL_PARAMETER_NAME',
            'OPENAI_TEMPERATURE_PARAMETER_NAME',
            'OPENAI_MAX_TOKENS_PARAMETER_NAME',
            'OPENAI_SYSTEM_PROMPT_PARAMETER_NAME',
            'OPENAI_USER_PROMPT_TEMPLATE_PARAMETER_NAME',
        ];
        return name ? null : labels[index];
    })
        .filter(Boolean);
    if (missingParams.length > 0) {
        throw new Error(`Missing environment variables: ${missingParams.join(', ')}`);
    }
    // Fetch all parameters in parallel
    const parameterPromises = parameterNames.map((name) => ssmClient.send(new client_ssm_1.GetParameterCommand({
        Name: name,
        WithDecryption: true,
    })));
    const responses = await Promise.all(parameterPromises);
    // Extract values
    const values = responses.map((response, index) => {
        if (!response.Parameter?.Value) {
            throw new Error(`Parameter ${parameterNames[index]} not found in SSM`);
        }
        return response.Parameter.Value;
    });
    return {
        apiKey: values[0],
        model: values[1],
        temperature: parseFloat(values[2]),
        maxTokens: parseInt(values[3], 10),
        systemPrompt: values[4],
        userPromptTemplate: values[5],
    };
}
async function getUserProfile(userId) {
    const response = await dynamoDoc.send(new lib_dynamodb_1.GetCommand({
        TableName: process.env.USER_TABLE_NAME,
        Key: {
            userId,
            createdAt: 'PROFILE',
        },
    }));
    return response.Item;
}
async function getNatalChart(userId) {
    const response = await dynamoDoc.send(new lib_dynamodb_1.GetCommand({
        TableName: process.env.NATAL_CHART_TABLE_NAME,
        Key: {
            userId,
        },
    }));
    return response.Item;
}
async function callOpenAI(prompt, config) {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${config.apiKey}`,
        },
        body: JSON.stringify({
            model: config.model,
            messages: [
                {
                    role: 'system',
                    content: config.systemPrompt,
                },
                {
                    role: 'user',
                    content: prompt,
                },
            ],
            temperature: config.temperature,
            max_tokens: config.maxTokens,
        }),
    });
    if (!response.ok) {
        const error = await response.text();
        throw new Error(`OpenAI API error: ${response.status} - ${error}`);
    }
    const data = (await response.json());
    return data.choices[0].message.content;
}
const handler = async (event) => {
    console.log('Event:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'POST,OPTIONS',
    };
    try {
        // Extract userId from path
        const userId = event.pathParameters?.userId;
        if (!userId) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({ message: 'userId is required' }),
            };
        }
        // Verify authenticated user matches requested userId
        const requestContext = event.requestContext;
        const authenticatedUserId = requestContext?.authorizer?.claims?.sub;
        if (authenticatedUserId !== userId) {
            return {
                statusCode: 403,
                headers: corsHeaders,
                body: JSON.stringify({ message: 'Unauthorized to generate reading for this user' }),
            };
        }
        // Get user profile and natal chart
        const [userProfile, natalChart] = await Promise.all([
            getUserProfile(userId),
            getNatalChart(userId),
        ]);
        if (!userProfile) {
            return {
                statusCode: 404,
                headers: corsHeaders,
                body: JSON.stringify({ message: 'User profile not found' }),
            };
        }
        if (!natalChart) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({
                    message: 'Natal chart not generated. Please complete your profile first.',
                }),
            };
        }
        // Generate reading ID and timestamp
        const readingId = (0, uuid_1.v4)();
        const timestamp = new Date().toISOString();
        // Create the reading record with status 'Processing'
        const readingRecord = {
            userId,
            readingId,
            type: 'Soul Blueprint',
            status: 'Processing',
            createdAt: timestamp,
            updatedAt: timestamp,
        };
        // Save initial reading record
        await dynamoDoc.send(new lib_dynamodb_1.PutCommand({
            TableName: process.env.READINGS_TABLE_NAME,
            Item: readingRecord,
        }));
        try {
            // Get OpenAI configuration
            const openAIConfig = await getOpenAIConfig();
            // Build user prompt from template
            const userPrompt = openAIConfig.userPromptTemplate
                .replace('{{birthName}}', userProfile.profile?.birthName || 'Unknown')
                .replace('{{birthDate}}', userProfile.profile?.birthDate || 'Unknown')
                .replace('{{birthTime}}', userProfile.profile?.birthTime || 'Unknown')
                .replace('{{birthCity}}', userProfile.profile?.birthCity || 'Unknown')
                .replace('{{birthState}}', userProfile.profile?.birthState || 'Unknown')
                .replace('{{birthCountry}}', userProfile.profile?.birthCountry || 'Unknown')
                .replace('{{natalChartData}}', JSON.stringify(natalChart, null, 2));
            // Call OpenAI API
            const content = await callOpenAI(userPrompt, openAIConfig);
            // Update reading with content and status
            const updatedReading = {
                ...readingRecord,
                content,
                status: 'Ready',
                updatedAt: new Date().toISOString(),
            };
            await dynamoDoc.send(new lib_dynamodb_1.PutCommand({
                TableName: process.env.READINGS_TABLE_NAME,
                Item: updatedReading,
            }));
            return {
                statusCode: 200,
                headers: corsHeaders,
                body: JSON.stringify({
                    message: 'Reading generated successfully',
                    readingId,
                    status: 'Ready',
                }),
            };
        }
        catch (error) {
            console.error('Error generating reading:', error);
            // Update reading status to Failed
            await dynamoDoc.send(new lib_dynamodb_1.PutCommand({
                TableName: process.env.READINGS_TABLE_NAME,
                Item: {
                    ...readingRecord,
                    status: 'Failed',
                    error: error instanceof Error ? error.message : 'Unknown error',
                    updatedAt: new Date().toISOString(),
                },
            }));
            throw error;
        }
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({
                message: 'Failed to generate reading',
                error: error instanceof Error ? error.message : 'Unknown error',
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUtcmVhZGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdlbmVyYXRlLXJlYWRpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUF1RjtBQUN2RixvREFBcUU7QUFDckUsK0JBQW9DO0FBRXBDLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUM1QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDNUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxzQkFBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBV3BDLEtBQUssVUFBVSxlQUFlO0lBQzVCLE1BQU0sY0FBYyxHQUFHO1FBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkJBQTZCO1FBQ3pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkJBQTJCO1FBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUNBQWlDO1FBQzdDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDO1FBQzVDLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUNBQW1DO1FBQy9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsMENBQTBDO0tBQ3ZELENBQUM7SUFFRiwyQ0FBMkM7SUFDM0MsTUFBTSxhQUFhLEdBQUcsY0FBYztTQUNqQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUU7UUFDbkIsTUFBTSxNQUFNLEdBQUc7WUFDYiwrQkFBK0I7WUFDL0IsNkJBQTZCO1lBQzdCLG1DQUFtQztZQUNuQyxrQ0FBa0M7WUFDbEMscUNBQXFDO1lBQ3JDLDRDQUE0QztTQUM3QyxDQUFDO1FBQ0YsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3JDLENBQUMsQ0FBQztTQUNELE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUVu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QzthQUNGLENBQUMsQ0FDSCxDQUFDO1lBRUYsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMvQixPQUFPO1lBQ0wsVUFBVSxFQUFFLEdBQUc7WUFDZixPQUFPLEVBQUUsV0FBVztZQUNwQixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFDbkIsT0FBTyxFQUFFLDRCQUE0QjtnQkFDckMsS0FBSyxFQUFFLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWU7YUFDaEUsQ0FBQztTQUNILENBQUM7SUFDSixDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBbkpXLFFBQUEsT0FBTyxXQW1KbEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBQdXRDb21tYW5kLCBHZXRDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IFNTTUNsaWVudCwgR2V0UGFyYW1ldGVyQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zc20nO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5cbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkeW5hbW9Eb2MgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcbmNvbnN0IHNzbUNsaWVudCA9IG5ldyBTU01DbGllbnQoe30pO1xuXG5pbnRlcmZhY2UgT3BlbkFJQ29uZmlnIHtcbiAgYXBpS2V5OiBzdHJpbmc7XG4gIG1vZGVsOiBzdHJpbmc7XG4gIHRlbXBlcmF0dXJlOiBudW1iZXI7XG4gIG1heFRva2VuczogbnVtYmVyO1xuICBzeXN0ZW1Qcm9tcHQ6IHN0cmluZztcbiAgdXNlclByb21wdFRlbXBsYXRlOiBzdHJpbmc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE9wZW5BSUNvbmZpZygpOiBQcm9taXNlPE9wZW5BSUNvbmZpZz4ge1xuICBjb25zdCBwYXJhbWV0ZXJOYW1lcyA9IFtcbiAgICBwcm9jZXNzLmVudi5PUEVOQUlfQVBJX0tFWV9QQVJBTUVURVJfTkFNRSxcbiAgICBwcm9jZXNzLmVudi5PUEVOQUlfTU9ERUxfUEFSQU1FVEVSX05BTUUsXG4gICAgcHJvY2Vzcy5lbnYuT1BFTkFJX1RFTVBFUkFUVVJFX1BBUkFNRVRFUl9OQU1FLFxuICAgIHByb2Nlc3MuZW52Lk9QRU5BSV9NQVhfVE9LRU5TX1BBUkFNRVRFUl9OQU1FLFxuICAgIHByb2Nlc3MuZW52Lk9QRU5BSV9TWVNURU1fUFJPTVBUX1BBUkFNRVRFUl9OQU1FLFxuICAgIHByb2Nlc3MuZW52Lk9QRU5BSV9VU0VSX1BST01QVF9URU1QTEFURV9QQVJBTUVURVJfTkFNRSxcbiAgXTtcblxuICAvLyBWYWxpZGF0ZSBhbGwgcGFyYW1ldGVyIG5hbWVzIGFyZSBwcmVzZW50XG4gIGNvbnN0IG1pc3NpbmdQYXJhbXMgPSBwYXJhbWV0ZXJOYW1lc1xuICAgIC5tYXAoKG5hbWUsIGluZGV4KSA9PiB7XG4gICAgICBjb25zdCBsYWJlbHMgPSBbXG4gICAgICAgICdPUEVOQUlfQVBJX0tFWV9QQVJBTUVURVJfTkFNRScsXG4gICAgICAgICdPUEVOQUlfTU9ERUxfUEFSQU1FVEVSX05BTUUnLFxuICAgICAgICAnT1BFTkFJX1RFTVBFUkFUVVJFX1BBUkFNRVRFUl9OQU1FJyxcbiAgICAgICAgJ09QRU5BSV9NQVhfVE9LRU5TX1BBUkFNRVRFUl9OQU1FJyxcbiAgICAgICAgJ09QRU5BSV9TWVNURU1fUFJPTVBUX1BBUkFNRVRFUl9OQU1FJyxcbiAgICAgICAgJ09QRU5BSV9VU0VSX1BST01QVF9URU1QTEFURV9QQVJBTUVURVJfTkFNRScsXG4gICAgICBdO1xuICAgICAgcmV0dXJuIG5hbWUgPyBudWxsIDogbGFiZWxzW2luZGV4XTtcbiAgICB9KVxuICAgIC5maWx0ZXIoQm9vbGVhbik7XG5cbiAgaWYgKG1pc3NpbmdQYXJhbXMubGVuZ3RoID4gMCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBlbnZpcm9ubWVudCB2YXJpYWJsZXM6ICR7bWlzc2luZ1BhcmFtcy5qb2luKCcsICcpfWApO1xuICB9XG5cbiAgLy8gRmV0Y2ggYWxsIHBhcmFtZXRlcnMgaW4gcGFyYWxsZWxcbiAgY29uc3QgcGFyYW1ldGVyUHJvbWlzZXMgPSBwYXJhbWV0ZXJOYW1lcy5tYXAoKG5hbWUpID0+XG4gICAgc3NtQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgR2V0UGFyYW1ldGVyQ29tbWFuZCh7XG4gICAgICAgIE5hbWU6IG5hbWUhLFxuICAgICAgICBXaXRoRGVjcnlwdGlvbjogdHJ1ZSxcbiAgICAgIH0pLFxuICAgICksXG4gICk7XG5cbiAgY29uc3QgcmVzcG9uc2VzID0gYXdhaXQgUHJvbWlzZS5hbGwocGFyYW1ldGVyUHJvbWlzZXMpO1xuXG4gIC8vIEV4dHJhY3QgdmFsdWVzXG4gIGNvbnN0IHZhbHVlcyA9IHJlc3BvbnNlcy5tYXAoKHJlc3BvbnNlLCBpbmRleCkgPT4ge1xuICAgIGlmICghcmVzcG9uc2UuUGFyYW1ldGVyPy5WYWx1ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBQYXJhbWV0ZXIgJHtwYXJhbWV0ZXJOYW1lc1tpbmRleF19IG5vdCBmb3VuZCBpbiBTU01gKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3BvbnNlLlBhcmFtZXRlci5WYWx1ZTtcbiAgfSk7XG5cbiAgcmV0dXJuIHtcbiAgICBhcGlLZXk6IHZhbHVlc1swXSxcbiAgICBtb2RlbDogdmFsdWVzWzFdLFxuICAgIHRlbXBlcmF0dXJlOiBwYXJzZUZsb2F0KHZhbHVlc1syXSksXG4gICAgbWF4VG9rZW5zOiBwYXJzZUludCh2YWx1ZXNbM10sIDEwKSxcbiAgICBzeXN0ZW1Qcm9tcHQ6IHZhbHVlc1s0XSxcbiAgICB1c2VyUHJvbXB0VGVtcGxhdGU6IHZhbHVlc1s1XSxcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0VXNlclByb2ZpbGUodXNlcklkOiBzdHJpbmcpIHtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkeW5hbW9Eb2Muc2VuZChcbiAgICBuZXcgR2V0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlVTRVJfVEFCTEVfTkFNRSEsXG4gICAgICBLZXk6IHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBjcmVhdGVkQXQ6ICdQUk9GSUxFJyxcbiAgICAgIH0sXG4gICAgfSksXG4gICk7XG4gIHJldHVybiByZXNwb25zZS5JdGVtO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXROYXRhbENoYXJ0KHVzZXJJZDogc3RyaW5nKSB7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZHluYW1vRG9jLnNlbmQoXG4gICAgbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5OQVRBTF9DSEFSVF9UQUJMRV9OQU1FISxcbiAgICAgIEtleToge1xuICAgICAgICB1c2VySWQsXG4gICAgICB9LFxuICAgIH0pLFxuICApO1xuICByZXR1cm4gcmVzcG9uc2UuSXRlbTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2FsbE9wZW5BSShwcm9tcHQ6IHN0cmluZywgY29uZmlnOiBPcGVuQUlDb25maWcpOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKCdodHRwczovL2FwaS5vcGVuYWkuY29tL3YxL2NoYXQvY29tcGxldGlvbnMnLCB7XG4gICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgaGVhZGVyczoge1xuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHtjb25maWcuYXBpS2V5fWAsXG4gICAgfSxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBtb2RlbDogY29uZmlnLm1vZGVsLFxuICAgICAgbWVzc2FnZXM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHJvbGU6ICdzeXN0ZW0nLFxuICAgICAgICAgIGNvbnRlbnQ6IGNvbmZpZy5zeXN0ZW1Qcm9tcHQsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICByb2xlOiAndXNlcicsXG4gICAgICAgICAgY29udGVudDogcHJvbXB0LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIHRlbXBlcmF0dXJlOiBjb25maWcudGVtcGVyYXR1cmUsXG4gICAgICBtYXhfdG9rZW5zOiBjb25maWcubWF4VG9rZW5zLFxuICAgIH0pLFxuICB9KTtcblxuICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgY29uc3QgZXJyb3IgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBPcGVuQUkgQVBJIGVycm9yOiAke3Jlc3BvbnNlLnN0YXR1c30gLSAke2Vycm9yfWApO1xuICB9XG5cbiAgY29uc3QgZGF0YSA9IChhd2FpdCByZXNwb25zZS5qc29uKCkpIGFzIHsgY2hvaWNlczogQXJyYXk8eyBtZXNzYWdlOiB7IGNvbnRlbnQ6IHN0cmluZyB9IH0+IH07XG4gIHJldHVybiBkYXRhLmNob2ljZXNbMF0ubWVzc2FnZS5jb250ZW50O1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICBjb25zb2xlLmxvZygnRXZlbnQ6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcblxuICBjb25zdCBjb3JzSGVhZGVycyA9IHtcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdQT1NULE9QVElPTlMnLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgLy8gRXh0cmFjdCB1c2VySWQgZnJvbSBwYXRoXG4gICAgY29uc3QgdXNlcklkID0gZXZlbnQucGF0aFBhcmFtZXRlcnM/LnVzZXJJZDtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiAndXNlcklkIGlzIHJlcXVpcmVkJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gVmVyaWZ5IGF1dGhlbnRpY2F0ZWQgdXNlciBtYXRjaGVzIHJlcXVlc3RlZCB1c2VySWRcbiAgICBjb25zdCByZXF1ZXN0Q29udGV4dCA9IGV2ZW50LnJlcXVlc3RDb250ZXh0IGFzIHsgYXV0aG9yaXplcj86IHsgY2xhaW1zPzogeyBzdWI/OiBzdHJpbmcgfSB9IH07XG4gICAgY29uc3QgYXV0aGVudGljYXRlZFVzZXJJZCA9IHJlcXVlc3RDb250ZXh0Py5hdXRob3JpemVyPy5jbGFpbXM/LnN1YjtcbiAgICBpZiAoYXV0aGVudGljYXRlZFVzZXJJZCAhPT0gdXNlcklkKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDMsXG4gICAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6ICdVbmF1dGhvcml6ZWQgdG8gZ2VuZXJhdGUgcmVhZGluZyBmb3IgdGhpcyB1c2VyJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gR2V0IHVzZXIgcHJvZmlsZSBhbmQgbmF0YWwgY2hhcnRcbiAgICBjb25zdCBbdXNlclByb2ZpbGUsIG5hdGFsQ2hhcnRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgZ2V0VXNlclByb2ZpbGUodXNlcklkKSxcbiAgICAgIGdldE5hdGFsQ2hhcnQodXNlcklkKSxcbiAgICBdKTtcblxuICAgIGlmICghdXNlclByb2ZpbGUpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwNCxcbiAgICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogJ1VzZXIgcHJvZmlsZSBub3QgZm91bmQnIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoIW5hdGFsQ2hhcnQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBtZXNzYWdlOiAnTmF0YWwgY2hhcnQgbm90IGdlbmVyYXRlZC4gUGxlYXNlIGNvbXBsZXRlIHlvdXIgcHJvZmlsZSBmaXJzdC4nLFxuICAgICAgICB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gR2VuZXJhdGUgcmVhZGluZyBJRCBhbmQgdGltZXN0YW1wXG4gICAgY29uc3QgcmVhZGluZ0lkID0gdXVpZHY0KCk7XG4gICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuXG4gICAgLy8gQ3JlYXRlIHRoZSByZWFkaW5nIHJlY29yZCB3aXRoIHN0YXR1cyAnUHJvY2Vzc2luZydcbiAgICBjb25zdCByZWFkaW5nUmVjb3JkID0ge1xuICAgICAgdXNlcklkLFxuICAgICAgcmVhZGluZ0lkLFxuICAgICAgdHlwZTogJ1NvdWwgQmx1ZXByaW50JyxcbiAgICAgIHN0YXR1czogJ1Byb2Nlc3NpbmcnLFxuICAgICAgY3JlYXRlZEF0OiB0aW1lc3RhbXAsXG4gICAgICB1cGRhdGVkQXQ6IHRpbWVzdGFtcCxcbiAgICB9O1xuXG4gICAgLy8gU2F2ZSBpbml0aWFsIHJlYWRpbmcgcmVjb3JkXG4gICAgYXdhaXQgZHluYW1vRG9jLnNlbmQoXG4gICAgICBuZXcgUHV0Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuUkVBRElOR1NfVEFCTEVfTkFNRSEsXG4gICAgICAgIEl0ZW06IHJlYWRpbmdSZWNvcmQsXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldCBPcGVuQUkgY29uZmlndXJhdGlvblxuICAgICAgY29uc3Qgb3BlbkFJQ29uZmlnID0gYXdhaXQgZ2V0T3BlbkFJQ29uZmlnKCk7XG5cbiAgICAgIC8vIEJ1aWxkIHVzZXIgcHJvbXB0IGZyb20gdGVtcGxhdGVcbiAgICAgIGNvbnN0IHVzZXJQcm9tcHQgPSBvcGVuQUlDb25maWcudXNlclByb21wdFRlbXBsYXRlXG4gICAgICAgIC5yZXBsYWNlKCd7e2JpcnRoTmFtZX19JywgdXNlclByb2ZpbGUucHJvZmlsZT8uYmlydGhOYW1lIHx8ICdVbmtub3duJylcbiAgICAgICAgLnJlcGxhY2UoJ3t7YmlydGhEYXRlfX0nLCB1c2VyUHJvZmlsZS5wcm9maWxlPy5iaXJ0aERhdGUgfHwgJ1Vua25vd24nKVxuICAgICAgICAucmVwbGFjZSgne3tiaXJ0aFRpbWV9fScsIHVzZXJQcm9maWxlLnByb2ZpbGU/LmJpcnRoVGltZSB8fCAnVW5rbm93bicpXG4gICAgICAgIC5yZXBsYWNlKCd7e2JpcnRoQ2l0eX19JywgdXNlclByb2ZpbGUucHJvZmlsZT8uYmlydGhDaXR5IHx8ICdVbmtub3duJylcbiAgICAgICAgLnJlcGxhY2UoJ3t7YmlydGhTdGF0ZX19JywgdXNlclByb2ZpbGUucHJvZmlsZT8uYmlydGhTdGF0ZSB8fCAnVW5rbm93bicpXG4gICAgICAgIC5yZXBsYWNlKCd7e2JpcnRoQ291bnRyeX19JywgdXNlclByb2ZpbGUucHJvZmlsZT8uYmlydGhDb3VudHJ5IHx8ICdVbmtub3duJylcbiAgICAgICAgLnJlcGxhY2UoJ3t7bmF0YWxDaGFydERhdGF9fScsIEpTT04uc3RyaW5naWZ5KG5hdGFsQ2hhcnQsIG51bGwsIDIpKTtcblxuICAgICAgLy8gQ2FsbCBPcGVuQUkgQVBJXG4gICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgY2FsbE9wZW5BSSh1c2VyUHJvbXB0LCBvcGVuQUlDb25maWcpO1xuXG4gICAgICAvLyBVcGRhdGUgcmVhZGluZyB3aXRoIGNvbnRlbnQgYW5kIHN0YXR1c1xuICAgICAgY29uc3QgdXBkYXRlZFJlYWRpbmcgPSB7XG4gICAgICAgIC4uLnJlYWRpbmdSZWNvcmQsXG4gICAgICAgIGNvbnRlbnQsXG4gICAgICAgIHN0YXR1czogJ1JlYWR5JyxcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICB9O1xuXG4gICAgICBhd2FpdCBkeW5hbW9Eb2Muc2VuZChcbiAgICAgICAgbmV3IFB1dENvbW1hbmQoe1xuICAgICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuUkVBRElOR1NfVEFCTEVfTkFNRSEsXG4gICAgICAgICAgSXRlbTogdXBkYXRlZFJlYWRpbmcsXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIG1lc3NhZ2U6ICdSZWFkaW5nIGdlbmVyYXRlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgICAgIHJlYWRpbmdJZCxcbiAgICAgICAgICBzdGF0dXM6ICdSZWFkeScsXG4gICAgICAgIH0pLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2VuZXJhdGluZyByZWFkaW5nOicsIGVycm9yKTtcblxuICAgICAgLy8gVXBkYXRlIHJlYWRpbmcgc3RhdHVzIHRvIEZhaWxlZFxuICAgICAgYXdhaXQgZHluYW1vRG9jLnNlbmQoXG4gICAgICAgIG5ldyBQdXRDb21tYW5kKHtcbiAgICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlJFQURJTkdTX1RBQkxFX05BTUUhLFxuICAgICAgICAgIEl0ZW06IHtcbiAgICAgICAgICAgIC4uLnJlYWRpbmdSZWNvcmQsXG4gICAgICAgICAgICBzdGF0dXM6ICdGYWlsZWQnLFxuICAgICAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBnZW5lcmF0ZSByZWFkaW5nJyxcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgICAgfSksXG4gICAgfTtcbiAgfVxufTtcbiJdfQ==