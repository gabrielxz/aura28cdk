"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const logger_1 = require("../utils/logger");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const READINGS_TABLE_NAME = process.env.READINGS_TABLE_NAME;
const USER_TABLE_NAME = process.env.USER_TABLE_NAME;
const handler = async (event) => {
    logger_1.logger.info('Get all readings event:', event);
    try {
        // Check if user is admin
        const userGroups = event.requestContext?.authorizer?.claims?.['cognito:groups'];
        const isAdmin = userGroups &&
            (typeof userGroups === 'string'
                ? userGroups.split(',').includes('admin')
                : Array.isArray(userGroups) && userGroups.includes('admin'));
        if (!isAdmin) {
            return {
                statusCode: 403,
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                },
                body: JSON.stringify({ error: 'Access denied. Admin privileges required.' }),
            };
        }
        // Parse query parameters with validation
        const queryParams = event.queryStringParameters || {};
        const startDate = queryParams.startDate;
        const endDate = queryParams.endDate;
        const status = queryParams.status;
        const type = queryParams.type;
        // Validate and sanitize userSearch parameter
        let userSearch;
        if (queryParams.userSearch) {
            // Remove any potentially malicious characters and limit length
            userSearch = queryParams.userSearch
                .replace(/[<>'"`;(){}]/g, '') // Remove potential XSS/injection characters
                .trim()
                .slice(0, 100); // Limit to 100 characters
            // Additional validation: ensure it's a valid search string
            if (userSearch.length === 0) {
                userSearch = undefined;
            }
        }
        // Parse and validate limit (pageSize)
        let limit = queryParams.limit ? parseInt(queryParams.limit, 10) : 25;
        if (limit > 100) {
            limit = 100; // Cap at 100
        }
        else if (limit < 1 || isNaN(limit)) {
            limit = 25; // Default to 25
        }
        const lastEvaluatedKey = queryParams.lastEvaluatedKey
            ? JSON.parse(Buffer.from(queryParams.lastEvaluatedKey, 'base64').toString())
            : undefined;
        // Validate date range (max 90 days)
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const daysDiff = Math.abs(end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24);
            if (daysDiff > 90) {
                return {
                    statusCode: 400,
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*',
                    },
                    body: JSON.stringify({
                        error: 'Date range cannot exceed 90 days',
                    }),
                };
            }
        }
        // Build filter expression
        const filterExpressions = [];
        const expressionAttributeNames = {};
        const expressionAttributeValues = {};
        if (startDate) {
            filterExpressions.push('createdAt >= :startDate');
            expressionAttributeValues[':startDate'] = startDate;
        }
        if (endDate) {
            filterExpressions.push('createdAt <= :endDate');
            expressionAttributeValues[':endDate'] = endDate + 'T23:59:59.999Z';
        }
        if (status) {
            filterExpressions.push('#status = :status');
            expressionAttributeNames['#status'] = 'status';
            expressionAttributeValues[':status'] = status;
        }
        if (type) {
            filterExpressions.push('#type = :type');
            expressionAttributeNames['#type'] = 'type';
            expressionAttributeValues[':type'] = type;
        }
        // Scan readings table
        const scanParams = {
            TableName: READINGS_TABLE_NAME,
            Limit: limit,
            ExclusiveStartKey: lastEvaluatedKey,
        };
        if (filterExpressions.length > 0) {
            scanParams.FilterExpression = filterExpressions.join(' AND ');
            if (Object.keys(expressionAttributeNames).length > 0) {
                scanParams.ExpressionAttributeNames = expressionAttributeNames;
            }
            scanParams.ExpressionAttributeValues = expressionAttributeValues;
        }
        const scanResult = await docClient.send(new lib_dynamodb_1.ScanCommand(scanParams));
        const readings = scanResult.Items || [];
        // If user search is provided, fetch user emails
        let filteredReadings = readings;
        if (userSearch) {
            // Fetch user profiles to match email
            const userPromises = [...new Set(readings.map((r) => r.userId))].map(async (userId) => {
                try {
                    const userResult = await docClient.send(new lib_dynamodb_1.GetCommand({
                        TableName: USER_TABLE_NAME,
                        Key: {
                            userId: userId,
                            createdAt: 'PROFILE',
                        },
                    }));
                    return userResult.Item;
                }
                catch (error) {
                    console.warn(`Failed to fetch user ${userId}:`, error);
                    return null;
                }
            });
            const users = await Promise.all(userPromises);
            const userMap = new Map(users.filter(Boolean).map((user) => [user.userId, user.email]));
            // Filter readings by user email
            filteredReadings = readings.filter((reading) => {
                const userEmail = userMap.get(reading.userId);
                return userEmail && userEmail.toLowerCase().includes(userSearch.toLowerCase());
            });
            // Add email to reading objects
            filteredReadings = filteredReadings.map((reading) => ({
                ...reading,
                userEmail: userMap.get(reading.userId),
            }));
        }
        else {
            // Still fetch emails for display
            const userIds = [...new Set(readings.map((r) => r.userId))];
            const userPromises = userIds.map(async (userId) => {
                try {
                    const userResult = await docClient.send(new lib_dynamodb_1.GetCommand({
                        TableName: USER_TABLE_NAME,
                        Key: {
                            userId: userId,
                            createdAt: 'PROFILE',
                        },
                    }));
                    return userResult.Item;
                }
                catch (error) {
                    console.warn(`Failed to fetch user ${userId}:`, error);
                    return null;
                }
            });
            const users = await Promise.all(userPromises);
            const userMap = new Map(users.filter(Boolean).map((user) => [user.userId, user.email]));
            filteredReadings = readings.map((reading) => ({
                ...reading,
                userEmail: userMap.get(reading.userId),
            }));
        }
        // Prepare response
        const response = {
            readings: filteredReadings,
            count: filteredReadings.length,
            lastEvaluatedKey: scanResult.LastEvaluatedKey
                ? Buffer.from(JSON.stringify(scanResult.LastEvaluatedKey)).toString('base64')
                : undefined,
        };
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify(response),
        };
    }
    catch (error) {
        logger_1.logger.error('Error in get-all-readings handler:', error);
        return {
            statusCode: 500,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWFsbC1yZWFkaW5ncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdldC1hbGwtcmVhZGluZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUsrQjtBQUMvQiw0Q0FBeUM7QUFFekMsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUU1RCxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW9CLENBQUM7QUFDN0QsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFnQixDQUFDO0FBVzlDLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUEyQixFQUFrQyxFQUFFO0lBQzNGLGVBQU0sQ0FBQyxJQUFJLENBQUMseUJBQXlCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFOUMsSUFBSSxDQUFDO1FBQ0gseUJBQXlCO1FBQ3pCLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxjQUFjLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDaEYsTUFBTSxPQUFPLEdBQ1gsVUFBVTtZQUNWLENBQUMsT0FBTyxVQUFVLEtBQUssUUFBUTtnQkFDN0IsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQztnQkFDekMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBRWpFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNiLE9BQU87Z0JBQ0wsVUFBVSxFQUFFLEdBQUc7Z0JBQ2YsT0FBTyxFQUFFO29CQUNQLGNBQWMsRUFBRSxr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QUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDO2dCQUM3RSxDQUFDLENBQUMsU0FBUztTQUNkLENBQUM7UUFFRixPQUFPO1lBQ0wsVUFBVSxFQUFFLEdBQUc7WUFDZixPQUFPLEVBQUU7Z0JBQ1AsY0FBYyxFQUFFLGtCQUFrQjtnQkFDbEMsNkJBQTZCLEVBQUUsR0FBRzthQUNuQztZQUNELElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztTQUMvQixDQUFDO0lBQ0osQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixlQUFNLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzFELE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRTtnQkFDUCxjQUFjLEVBQUUsa0JBQWtCO2dCQUNsQyw2QkFBNkIsRUFBRSxHQUFHO2FBQ25DO1lBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQztTQUN6RCxDQUFDO0lBQ0osQ0FBQztBQUNILENBQUMsQ0FBQztBQXhOVyxRQUFBLE9BQU8sV0F3TmxCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHtcbiAgRHluYW1vREJEb2N1bWVudENsaWVudCxcbiAgU2NhbkNvbW1hbmQsXG4gIEdldENvbW1hbmQsXG4gIFNjYW5Db21tYW5kSW5wdXQsXG59IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuXG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGR5bmFtb0NsaWVudCk7XG5cbmNvbnN0IFJFQURJTkdTX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5SRUFESU5HU19UQUJMRV9OQU1FITtcbmNvbnN0IFVTRVJfVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LlVTRVJfVEFCTEVfTkFNRSE7XG5cbmludGVyZmFjZSBSZWFkaW5nIHtcbiAgcmVhZGluZ0lkOiBzdHJpbmc7XG4gIHVzZXJJZDogc3RyaW5nO1xuICB0eXBlOiBzdHJpbmc7XG4gIHN0YXR1czogc3RyaW5nO1xuICBjcmVhdGVkQXQ6IHN0cmluZztcbiAgdXBkYXRlZEF0OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIGxvZ2dlci5pbmZvKCdHZXQgYWxsIHJlYWRpbmdzIGV2ZW50OicsIGV2ZW50KTtcblxuICB0cnkge1xuICAgIC8vIENoZWNrIGlmIHVzZXIgaXMgYWRtaW5cbiAgICBjb25zdCB1c2VyR3JvdXBzID0gZXZlbnQucmVxdWVzdENvbnRleHQ/LmF1dGhvcml6ZXI/LmNsYWltcz8uWydjb2duaXRvOmdyb3VwcyddO1xuICAgIGNvbnN0IGlzQWRtaW4gPVxuICAgICAgdXNlckdyb3VwcyAmJlxuICAgICAgKHR5cGVvZiB1c2VyR3JvdXBzID09PSAnc3RyaW5nJ1xuICAgICAgICA/IHVzZXJHcm91cHMuc3BsaXQoJywnKS5pbmNsdWRlcygnYWRtaW4nKVxuICAgICAgICA6IEFycmF5LmlzQXJyYXkodXNlckdyb3VwcykgJiYgdXNlckdyb3Vwcy5pbmNsdWRlcygnYWRtaW4nKSk7XG5cbiAgICBpZiAoIWlzQWRtaW4pIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQuIEFkbWluIHByaXZpbGVnZXMgcmVxdWlyZWQuJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gUGFyc2UgcXVlcnkgcGFyYW1ldGVycyB3aXRoIHZhbGlkYXRpb25cbiAgICBjb25zdCBxdWVyeVBhcmFtcyA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fTtcbiAgICBjb25zdCBzdGFydERhdGUgPSBxdWVyeVBhcmFtcy5zdGFydERhdGU7XG4gICAgY29uc3QgZW5kRGF0ZSA9IHF1ZXJ5UGFyYW1zLmVuZERhdGU7XG4gICAgY29uc3Qgc3RhdHVzID0gcXVlcnlQYXJhbXMuc3RhdHVzO1xuICAgIGNvbnN0IHR5cGUgPSBxdWVyeVBhcmFtcy50eXBlO1xuXG4gICAgLy8gVmFsaWRhdGUgYW5kIHNhbml0aXplIHVzZXJTZWFyY2ggcGFyYW1ldGVyXG4gICAgbGV0IHVzZXJTZWFyY2g6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBpZiAocXVlcnlQYXJhbXMudXNlclNlYXJjaCkge1xuICAgICAgLy8gUmVtb3ZlIGFueSBwb3RlbnRpYWxseSBtYWxpY2lvdXMgY2hhcmFjdGVycyBhbmQgbGltaXQgbGVuZ3RoXG4gICAgICB1c2VyU2VhcmNoID0gcXVlcnlQYXJhbXMudXNlclNlYXJjaFxuICAgICAgICAucmVwbGFjZSgvWzw+J1wiYDsoKXt9XS9nLCAnJykgLy8gUmVtb3ZlIHBvdGVudGlhbCBYU1MvaW5qZWN0aW9uIGNoYXJhY3RlcnNcbiAgICAgICAgLnRyaW0oKVxuICAgICAgICAuc2xpY2UoMCwgMTAwKTsgLy8gTGltaXQgdG8gMTAwIGNoYXJhY3RlcnNcblxuICAgICAgLy8gQWRkaXRpb25hbCB2YWxpZGF0aW9uOiBlbnN1cmUgaXQncyBhIHZhbGlkIHNlYXJjaCBzdHJpbmdcbiAgICAgIGlmICh1c2VyU2VhcmNoLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB1c2VyU2VhcmNoID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFBhcnNlIGFuZCB2YWxpZGF0ZSBsaW1pdCAocGFnZVNpemUpXG4gICAgbGV0IGxpbWl0ID0gcXVlcnlQYXJhbXMubGltaXQgPyBwYXJzZUludChxdWVyeVBhcmFtcy5saW1pdCwgMTApIDogMjU7XG4gICAgaWYgKGxpbWl0ID4gMTAwKSB7XG4gICAgICBsaW1pdCA9IDEwMDsgLy8gQ2FwIGF0IDEwMFxuICAgIH0gZWxzZSBpZiAobGltaXQgPCAxIHx8IGlzTmFOKGxpbWl0KSkge1xuICAgICAgbGltaXQgPSAyNTsgLy8gRGVmYXVsdCB0byAyNVxuICAgIH1cblxuICAgIGNvbnN0IGxhc3RFdmFsdWF0ZWRLZXkgPSBxdWVyeVBhcmFtcy5sYXN0RXZhbHVhdGVkS2V5XG4gICAgICA/IEpTT04ucGFyc2UoQnVmZmVyLmZyb20ocXVlcnlQYXJhbXMubGFzdEV2YWx1YXRlZEtleSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCkpXG4gICAgICA6IHVuZGVmaW5lZDtcblxuICAgIC8vIFZhbGlkYXRlIGRhdGUgcmFuZ2UgKG1heCA5MCBkYXlzKVxuICAgIGlmIChzdGFydERhdGUgJiYgZW5kRGF0ZSkge1xuICAgICAgY29uc3Qgc3RhcnQgPSBuZXcgRGF0ZShzdGFydERhdGUpO1xuICAgICAgY29uc3QgZW5kID0gbmV3IERhdGUoZW5kRGF0ZSk7XG4gICAgICBjb25zdCBkYXlzRGlmZiA9IE1hdGguYWJzKGVuZC5nZXRUaW1lKCkgLSBzdGFydC5nZXRUaW1lKCkpIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpO1xuXG4gICAgICBpZiAoZGF5c0RpZmYgPiA5MCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIGVycm9yOiAnRGF0ZSByYW5nZSBjYW5ub3QgZXhjZWVkIDkwIGRheXMnLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEJ1aWxkIGZpbHRlciBleHByZXNzaW9uXG4gICAgY29uc3QgZmlsdGVyRXhwcmVzc2lvbnM6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gICAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgbnVtYmVyPiA9IHt9O1xuXG4gICAgaWYgKHN0YXJ0RGF0ZSkge1xuICAgICAgZmlsdGVyRXhwcmVzc2lvbnMucHVzaCgnY3JlYXRlZEF0ID49IDpzdGFydERhdGUnKTtcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzpzdGFydERhdGUnXSA9IHN0YXJ0RGF0ZTtcbiAgICB9XG5cbiAgICBpZiAoZW5kRGF0ZSkge1xuICAgICAgZmlsdGVyRXhwcmVzc2lvbnMucHVzaCgnY3JlYXRlZEF0IDw9IDplbmREYXRlJyk7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6ZW5kRGF0ZSddID0gZW5kRGF0ZSArICdUMjM6NTk6NTkuOTk5Wic7XG4gICAgfVxuXG4gICAgaWYgKHN0YXR1cykge1xuICAgICAgZmlsdGVyRXhwcmVzc2lvbnMucHVzaCgnI3N0YXR1cyA9IDpzdGF0dXMnKTtcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1snI3N0YXR1cyddID0gJ3N0YXR1cyc7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6c3RhdHVzJ10gPSBzdGF0dXM7XG4gICAgfVxuXG4gICAgaWYgKHR5cGUpIHtcbiAgICAgIGZpbHRlckV4cHJlc3Npb25zLnB1c2goJyN0eXBlID0gOnR5cGUnKTtcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1snI3R5cGUnXSA9ICd0eXBlJztcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzp0eXBlJ10gPSB0eXBlO1xuICAgIH1cblxuICAgIC8vIFNjYW4gcmVhZGluZ3MgdGFibGVcbiAgICBjb25zdCBzY2FuUGFyYW1zOiBTY2FuQ29tbWFuZElucHV0ID0ge1xuICAgICAgVGFibGVOYW1lOiBSRUFESU5HU19UQUJMRV9OQU1FLFxuICAgICAgTGltaXQ6IGxpbWl0LFxuICAgICAgRXhjbHVzaXZlU3RhcnRLZXk6IGxhc3RFdmFsdWF0ZWRLZXksXG4gICAgfTtcblxuICAgIGlmIChmaWx0ZXJFeHByZXNzaW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICBzY2FuUGFyYW1zLkZpbHRlckV4cHJlc3Npb24gPSBmaWx0ZXJFeHByZXNzaW9ucy5qb2luKCcgQU5EICcpO1xuICAgICAgaWYgKE9iamVjdC5rZXlzKGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcykubGVuZ3RoID4gMCkge1xuICAgICAgICBzY2FuUGFyYW1zLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyA9IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcztcbiAgICAgIH1cbiAgICAgIHNjYW5QYXJhbXMuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyA9IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM7XG4gICAgfVxuXG4gICAgY29uc3Qgc2NhblJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBTY2FuQ29tbWFuZChzY2FuUGFyYW1zKSk7XG4gICAgY29uc3QgcmVhZGluZ3MgPSAoc2NhblJlc3VsdC5JdGVtcyBhcyBSZWFkaW5nW10pIHx8IFtdO1xuXG4gICAgLy8gSWYgdXNlciBzZWFyY2ggaXMgcHJvdmlkZWQsIGZldGNoIHVzZXIgZW1haWxzXG4gICAgbGV0IGZpbHRlcmVkUmVhZGluZ3MgPSByZWFkaW5ncztcbiAgICBpZiAodXNlclNlYXJjaCkge1xuICAgICAgLy8gRmV0Y2ggdXNlciBwcm9maWxlcyB0byBtYXRjaCBlbWFpbFxuICAgICAgY29uc3QgdXNlclByb21pc2VzID0gWy4uLm5ldyBTZXQocmVhZGluZ3MubWFwKChyKSA9PiByLnVzZXJJZCkpXS5tYXAoYXN5bmMgKHVzZXJJZCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHVzZXJSZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICAgICAgICAgIG5ldyBHZXRDb21tYW5kKHtcbiAgICAgICAgICAgICAgVGFibGVOYW1lOiBVU0VSX1RBQkxFX05BTUUsXG4gICAgICAgICAgICAgIEtleToge1xuICAgICAgICAgICAgICAgIHVzZXJJZDogdXNlcklkLFxuICAgICAgICAgICAgICAgIGNyZWF0ZWRBdDogJ1BST0ZJTEUnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgKTtcbiAgICAgICAgICByZXR1cm4gdXNlclJlc3VsdC5JdGVtO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGNvbnNvbGUud2FybihgRmFpbGVkIHRvIGZldGNoIHVzZXIgJHt1c2VySWR9OmAsIGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHVzZXJzID0gYXdhaXQgUHJvbWlzZS5hbGwodXNlclByb21pc2VzKTtcbiAgICAgIGNvbnN0IHVzZXJNYXAgPSBuZXcgTWFwKHVzZXJzLmZpbHRlcihCb29sZWFuKS5tYXAoKHVzZXIpID0+IFt1c2VyIS51c2VySWQsIHVzZXIhLmVtYWlsXSkpO1xuXG4gICAgICAvLyBGaWx0ZXIgcmVhZGluZ3MgYnkgdXNlciBlbWFpbFxuICAgICAgZmlsdGVyZWRSZWFkaW5ncyA9IHJlYWRpbmdzLmZpbHRlcigocmVhZGluZykgPT4ge1xuICAgICAgICBjb25zdCB1c2VyRW1haWwgPSB1c2VyTWFwLmdldChyZWFkaW5nLnVzZXJJZCk7XG4gICAgICAgIHJldHVybiB1c2VyRW1haWwgJiYgdXNlckVtYWlsLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXModXNlclNlYXJjaC50b0xvd2VyQ2FzZSgpKTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBBZGQgZW1haWwgdG8gcmVhZGluZyBvYmplY3RzXG4gICAgICBmaWx0ZXJlZFJlYWRpbmdzID0gZmlsdGVyZWRSZWFkaW5ncy5tYXAoKHJlYWRpbmcpID0+ICh7XG4gICAgICAgIC4uLnJlYWRpbmcsXG4gICAgICAgIHVzZXJFbWFpbDogdXNlck1hcC5nZXQocmVhZGluZy51c2VySWQpLFxuICAgICAgfSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBTdGlsbCBmZXRjaCBlbWFpbHMgZm9yIGRpc3BsYXlcbiAgICAgIGNvbnN0IHVzZXJJZHMgPSBbLi4ubmV3IFNldChyZWFkaW5ncy5tYXAoKHIpID0+IHIudXNlcklkKSldO1xuICAgICAgY29uc3QgdXNlclByb21pc2VzID0gdXNlcklkcy5tYXAoYXN5bmMgKHVzZXJJZCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHVzZXJSZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICAgICAgICAgIG5ldyBHZXRDb21tYW5kKHtcbiAgICAgICAgICAgICAgVGFibGVOYW1lOiBVU0VSX1RBQkxFX05BTUUsXG4gICAgICAgICAgICAgIEtleToge1xuICAgICAgICAgICAgICAgIHVzZXJJZDogdXNlcklkLFxuICAgICAgICAgICAgICAgIGNyZWF0ZWRBdDogJ1BST0ZJTEUnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgKTtcbiAgICAgICAgICByZXR1cm4gdXNlclJlc3VsdC5JdGVtO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGNvbnNvbGUud2FybihgRmFpbGVkIHRvIGZldGNoIHVzZXIgJHt1c2VySWR9OmAsIGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHVzZXJzID0gYXdhaXQgUHJvbWlzZS5hbGwodXNlclByb21pc2VzKTtcbiAgICAgIGNvbnN0IHVzZXJNYXAgPSBuZXcgTWFwKHVzZXJzLmZpbHRlcihCb29sZWFuKS5tYXAoKHVzZXIpID0+IFt1c2VyIS51c2VySWQsIHVzZXIhLmVtYWlsXSkpO1xuXG4gICAgICBmaWx0ZXJlZFJlYWRpbmdzID0gcmVhZGluZ3MubWFwKChyZWFkaW5nKSA9PiAoe1xuICAgICAgICAuLi5yZWFkaW5nLFxuICAgICAgICB1c2VyRW1haWw6IHVzZXJNYXAuZ2V0KHJlYWRpbmcudXNlcklkKSxcbiAgICAgIH0pKTtcbiAgICB9XG5cbiAgICAvLyBQcmVwYXJlIHJlc3BvbnNlXG4gICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICByZWFkaW5nczogZmlsdGVyZWRSZWFkaW5ncyxcbiAgICAgIGNvdW50OiBmaWx0ZXJlZFJlYWRpbmdzLmxlbmd0aCxcbiAgICAgIGxhc3RFdmFsdWF0ZWRLZXk6IHNjYW5SZXN1bHQuTGFzdEV2YWx1YXRlZEtleVxuICAgICAgICA/IEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KHNjYW5SZXN1bHQuTGFzdEV2YWx1YXRlZEtleSkpLnRvU3RyaW5nKCdiYXNlNjQnKVxuICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXNwb25zZSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIGdldC1hbGwtcmVhZGluZ3MgaGFuZGxlcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KSxcbiAgICB9O1xuICB9XG59O1xuIl19