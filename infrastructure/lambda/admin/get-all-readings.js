"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const READINGS_TABLE_NAME = process.env.READINGS_TABLE_NAME;
const USER_TABLE_NAME = process.env.USER_TABLE_NAME;
const handler = async (event) => {
    console.info('Get all readings event:', JSON.stringify(event, null, 2));
    try {
        // Check if user is admin
        const userGroups = event.requestContext.authorizer?.claims?.['cognito:groups'];
        const isAdmin = userGroups &&
            (typeof userGroups === 'string'
                ? userGroups.split(',').includes('admin')
                : Array.isArray(userGroups) && userGroups.includes('admin'));
        if (!isAdmin) {
            return {
                statusCode: 403,
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                },
                body: JSON.stringify({ error: 'Access denied. Admin privileges required.' }),
            };
        }
        // Parse query parameters
        const queryParams = event.queryStringParameters || {};
        const startDate = queryParams.startDate;
        const endDate = queryParams.endDate;
        const status = queryParams.status;
        const type = queryParams.type;
        const userSearch = queryParams.userSearch;
        const limit = queryParams.limit ? parseInt(queryParams.limit, 10) : 25;
        const lastEvaluatedKey = queryParams.lastEvaluatedKey
            ? JSON.parse(Buffer.from(queryParams.lastEvaluatedKey, 'base64').toString())
            : undefined;
        // Build filter expression
        const filterExpressions = [];
        const expressionAttributeNames = {};
        const expressionAttributeValues = {};
        if (startDate) {
            filterExpressions.push('createdAt >= :startDate');
            expressionAttributeValues[':startDate'] = startDate;
        }
        if (endDate) {
            filterExpressions.push('createdAt <= :endDate');
            expressionAttributeValues[':endDate'] = endDate + 'T23:59:59.999Z';
        }
        if (status) {
            filterExpressions.push('#status = :status');
            expressionAttributeNames['#status'] = 'status';
            expressionAttributeValues[':status'] = status;
        }
        if (type) {
            filterExpressions.push('#type = :type');
            expressionAttributeNames['#type'] = 'type';
            expressionAttributeValues[':type'] = type;
        }
        // Scan readings table
        const scanParams = {
            TableName: READINGS_TABLE_NAME,
            Limit: limit,
            ExclusiveStartKey: lastEvaluatedKey,
        };
        if (filterExpressions.length > 0) {
            scanParams.FilterExpression = filterExpressions.join(' AND ');
            if (Object.keys(expressionAttributeNames).length > 0) {
                scanParams.ExpressionAttributeNames = expressionAttributeNames;
            }
            scanParams.ExpressionAttributeValues = expressionAttributeValues;
        }
        const scanResult = await docClient.send(new lib_dynamodb_1.ScanCommand(scanParams));
        const readings = scanResult.Items || [];
        // If user search is provided, fetch user emails
        let filteredReadings = readings;
        if (userSearch) {
            // Fetch user profiles to match email
            const userPromises = [...new Set(readings.map((r) => r.userId))].map(async (userId) => {
                try {
                    const userResult = await docClient.send(new lib_dynamodb_1.GetCommand({
                        TableName: USER_TABLE_NAME,
                        Key: {
                            userId: userId,
                            createdAt: 'PROFILE',
                        },
                    }));
                    return userResult.Item;
                }
                catch (error) {
                    console.warn(`Failed to fetch user ${userId}:`, error);
                    return null;
                }
            });
            const users = await Promise.all(userPromises);
            const userMap = new Map(users.filter(Boolean).map((user) => [user.userId, user.email]));
            // Filter readings by user email
            filteredReadings = readings.filter((reading) => {
                const userEmail = userMap.get(reading.userId);
                return userEmail && userEmail.toLowerCase().includes(userSearch.toLowerCase());
            });
            // Add email to reading objects
            filteredReadings = filteredReadings.map((reading) => ({
                ...reading,
                userEmail: userMap.get(reading.userId),
            }));
        }
        else {
            // Still fetch emails for display
            const userIds = [...new Set(readings.map((r) => r.userId))];
            const userPromises = userIds.map(async (userId) => {
                try {
                    const userResult = await docClient.send(new lib_dynamodb_1.GetCommand({
                        TableName: USER_TABLE_NAME,
                        Key: {
                            userId: userId,
                            createdAt: 'PROFILE',
                        },
                    }));
                    return userResult.Item;
                }
                catch (error) {
                    console.warn(`Failed to fetch user ${userId}:`, error);
                    return null;
                }
            });
            const users = await Promise.all(userPromises);
            const userMap = new Map(users.filter(Boolean).map((user) => [user.userId, user.email]));
            filteredReadings = readings.map((reading) => ({
                ...reading,
                userEmail: userMap.get(reading.userId),
            }));
        }
        // Prepare response
        const response = {
            readings: filteredReadings,
            count: filteredReadings.length,
            lastEvaluatedKey: scanResult.LastEvaluatedKey
                ? Buffer.from(JSON.stringify(scanResult.LastEvaluatedKey)).toString('base64')
                : undefined,
        };
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify(response),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWFsbC1yZWFkaW5ncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdldC1hbGwtcmVhZGluZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUsrQjtBQUUvQixNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBRTVELE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBb0IsQ0FBQztBQUM3RCxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWdCLENBQUM7QUFXOUMsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQTJCLEVBQWtDLEVBQUU7SUFDM0YsT0FBTyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUV4RSxJQUFJLENBQUM7UUFDSCx5QkFBeUI7UUFDekIsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUMvRSxNQUFNLE9BQU8sR0FDWCxVQUFVO1lBQ1YsQ0FBQyxPQUFPLFVBQVUsS0FBSyxRQUFRO2dCQUM3QixDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO2dCQUN6QyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxVQUFVLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFakUsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2IsT0FBTztnQkFDTCxVQUFVLEVBQUUsR0FBRztn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QUUsR0FBRztZQUNmLE9BQU8sRUFBRTtnQkFDUCxjQUFjLEVBQUUsa0JBQWtCO2dCQUNsQyw2QkFBNkIsRUFBRSxHQUFHO2FBQ25DO1lBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1NBQy9CLENBQUM7SUFDSixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQy9CLE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRTtnQkFDUCxjQUFjLEVBQUUsa0JBQWtCO2dCQUNsQyw2QkFBNkIsRUFBRSxHQUFHO2FBQ25DO1lBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQztTQUN6RCxDQUFDO0lBQ0osQ0FBQztBQUNILENBQUMsQ0FBQztBQTlLVyxRQUFBLE9BQU8sV0E4S2xCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHtcbiAgRHluYW1vREJEb2N1bWVudENsaWVudCxcbiAgU2NhbkNvbW1hbmQsXG4gIEdldENvbW1hbmQsXG4gIFNjYW5Db21tYW5kSW5wdXQsXG59IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5cbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcblxuY29uc3QgUkVBRElOR1NfVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LlJFQURJTkdTX1RBQkxFX05BTUUhO1xuY29uc3QgVVNFUl9UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuVVNFUl9UQUJMRV9OQU1FITtcblxuaW50ZXJmYWNlIFJlYWRpbmcge1xuICByZWFkaW5nSWQ6IHN0cmluZztcbiAgdXNlcklkOiBzdHJpbmc7XG4gIHR5cGU6IHN0cmluZztcbiAgc3RhdHVzOiBzdHJpbmc7XG4gIGNyZWF0ZWRBdDogc3RyaW5nO1xuICB1cGRhdGVkQXQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgY29uc29sZS5pbmZvKCdHZXQgYWxsIHJlYWRpbmdzIGV2ZW50OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50LCBudWxsLCAyKSk7XG5cbiAgdHJ5IHtcbiAgICAvLyBDaGVjayBpZiB1c2VyIGlzIGFkbWluXG4gICAgY29uc3QgdXNlckdyb3VwcyA9IGV2ZW50LnJlcXVlc3RDb250ZXh0LmF1dGhvcml6ZXI/LmNsYWltcz8uWydjb2duaXRvOmdyb3VwcyddO1xuICAgIGNvbnN0IGlzQWRtaW4gPVxuICAgICAgdXNlckdyb3VwcyAmJlxuICAgICAgKHR5cGVvZiB1c2VyR3JvdXBzID09PSAnc3RyaW5nJ1xuICAgICAgICA/IHVzZXJHcm91cHMuc3BsaXQoJywnKS5pbmNsdWRlcygnYWRtaW4nKVxuICAgICAgICA6IEFycmF5LmlzQXJyYXkodXNlckdyb3VwcykgJiYgdXNlckdyb3Vwcy5pbmNsdWRlcygnYWRtaW4nKSk7XG5cbiAgICBpZiAoIWlzQWRtaW4pIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQuIEFkbWluIHByaXZpbGVnZXMgcmVxdWlyZWQuJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gUGFyc2UgcXVlcnkgcGFyYW1ldGVyc1xuICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzIHx8IHt9O1xuICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IHF1ZXJ5UGFyYW1zLnN0YXJ0RGF0ZTtcbiAgICBjb25zdCBlbmREYXRlID0gcXVlcnlQYXJhbXMuZW5kRGF0ZTtcbiAgICBjb25zdCBzdGF0dXMgPSBxdWVyeVBhcmFtcy5zdGF0dXM7XG4gICAgY29uc3QgdHlwZSA9IHF1ZXJ5UGFyYW1zLnR5cGU7XG4gICAgY29uc3QgdXNlclNlYXJjaCA9IHF1ZXJ5UGFyYW1zLnVzZXJTZWFyY2g7XG4gICAgY29uc3QgbGltaXQgPSBxdWVyeVBhcmFtcy5saW1pdCA/IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLmxpbWl0LCAxMCkgOiAyNTtcbiAgICBjb25zdCBsYXN0RXZhbHVhdGVkS2V5ID0gcXVlcnlQYXJhbXMubGFzdEV2YWx1YXRlZEtleVxuICAgICAgPyBKU09OLnBhcnNlKEJ1ZmZlci5mcm9tKHF1ZXJ5UGFyYW1zLmxhc3RFdmFsdWF0ZWRLZXksICdiYXNlNjQnKS50b1N0cmluZygpKVxuICAgICAgOiB1bmRlZmluZWQ7XG5cbiAgICAvLyBCdWlsZCBmaWx0ZXIgZXhwcmVzc2lvblxuICAgIGNvbnN0IGZpbHRlckV4cHJlc3Npb25zOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IG51bWJlcj4gPSB7fTtcblxuICAgIGlmIChzdGFydERhdGUpIHtcbiAgICAgIGZpbHRlckV4cHJlc3Npb25zLnB1c2goJ2NyZWF0ZWRBdCA+PSA6c3RhcnREYXRlJyk7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6c3RhcnREYXRlJ10gPSBzdGFydERhdGU7XG4gICAgfVxuXG4gICAgaWYgKGVuZERhdGUpIHtcbiAgICAgIGZpbHRlckV4cHJlc3Npb25zLnB1c2goJ2NyZWF0ZWRBdCA8PSA6ZW5kRGF0ZScpO1xuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOmVuZERhdGUnXSA9IGVuZERhdGUgKyAnVDIzOjU5OjU5Ljk5OVonO1xuICAgIH1cblxuICAgIGlmIChzdGF0dXMpIHtcbiAgICAgIGZpbHRlckV4cHJlc3Npb25zLnB1c2goJyNzdGF0dXMgPSA6c3RhdHVzJyk7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbJyNzdGF0dXMnXSA9ICdzdGF0dXMnO1xuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXR1cyddID0gc3RhdHVzO1xuICAgIH1cblxuICAgIGlmICh0eXBlKSB7XG4gICAgICBmaWx0ZXJFeHByZXNzaW9ucy5wdXNoKCcjdHlwZSA9IDp0eXBlJyk7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbJyN0eXBlJ10gPSAndHlwZSc7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6dHlwZSddID0gdHlwZTtcbiAgICB9XG5cbiAgICAvLyBTY2FuIHJlYWRpbmdzIHRhYmxlXG4gICAgY29uc3Qgc2NhblBhcmFtczogU2NhbkNvbW1hbmRJbnB1dCA9IHtcbiAgICAgIFRhYmxlTmFtZTogUkVBRElOR1NfVEFCTEVfTkFNRSxcbiAgICAgIExpbWl0OiBsaW1pdCxcbiAgICAgIEV4Y2x1c2l2ZVN0YXJ0S2V5OiBsYXN0RXZhbHVhdGVkS2V5LFxuICAgIH07XG5cbiAgICBpZiAoZmlsdGVyRXhwcmVzc2lvbnMubGVuZ3RoID4gMCkge1xuICAgICAgc2NhblBhcmFtcy5GaWx0ZXJFeHByZXNzaW9uID0gZmlsdGVyRXhwcmVzc2lvbnMuam9pbignIEFORCAnKTtcbiAgICAgIGlmIChPYmplY3Qua2V5cyhleHByZXNzaW9uQXR0cmlidXRlTmFtZXMpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgc2NhblBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMgPSBleHByZXNzaW9uQXR0cmlidXRlTmFtZXM7XG4gICAgICB9XG4gICAgICBzY2FuUGFyYW1zLkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPSBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzO1xuICAgIH1cblxuICAgIGNvbnN0IHNjYW5SZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChuZXcgU2NhbkNvbW1hbmQoc2NhblBhcmFtcykpO1xuICAgIGNvbnN0IHJlYWRpbmdzID0gKHNjYW5SZXN1bHQuSXRlbXMgYXMgUmVhZGluZ1tdKSB8fCBbXTtcblxuICAgIC8vIElmIHVzZXIgc2VhcmNoIGlzIHByb3ZpZGVkLCBmZXRjaCB1c2VyIGVtYWlsc1xuICAgIGxldCBmaWx0ZXJlZFJlYWRpbmdzID0gcmVhZGluZ3M7XG4gICAgaWYgKHVzZXJTZWFyY2gpIHtcbiAgICAgIC8vIEZldGNoIHVzZXIgcHJvZmlsZXMgdG8gbWF0Y2ggZW1haWxcbiAgICAgIGNvbnN0IHVzZXJQcm9taXNlcyA9IFsuLi5uZXcgU2V0KHJlYWRpbmdzLm1hcCgocikgPT4gci51c2VySWQpKV0ubWFwKGFzeW5jICh1c2VySWQpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCB1c2VyUmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoXG4gICAgICAgICAgICBuZXcgR2V0Q29tbWFuZCh7XG4gICAgICAgICAgICAgIFRhYmxlTmFtZTogVVNFUl9UQUJMRV9OQU1FLFxuICAgICAgICAgICAgICBLZXk6IHtcbiAgICAgICAgICAgICAgICB1c2VySWQ6IHVzZXJJZCxcbiAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6ICdQUk9GSUxFJyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIHVzZXJSZXN1bHQuSXRlbTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oYEZhaWxlZCB0byBmZXRjaCB1c2VyICR7dXNlcklkfTpgLCBlcnJvcik7XG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB1c2VycyA9IGF3YWl0IFByb21pc2UuYWxsKHVzZXJQcm9taXNlcyk7XG4gICAgICBjb25zdCB1c2VyTWFwID0gbmV3IE1hcCh1c2Vycy5maWx0ZXIoQm9vbGVhbikubWFwKCh1c2VyKSA9PiBbdXNlciEudXNlcklkLCB1c2VyIS5lbWFpbF0pKTtcblxuICAgICAgLy8gRmlsdGVyIHJlYWRpbmdzIGJ5IHVzZXIgZW1haWxcbiAgICAgIGZpbHRlcmVkUmVhZGluZ3MgPSByZWFkaW5ncy5maWx0ZXIoKHJlYWRpbmcpID0+IHtcbiAgICAgICAgY29uc3QgdXNlckVtYWlsID0gdXNlck1hcC5nZXQocmVhZGluZy51c2VySWQpO1xuICAgICAgICByZXR1cm4gdXNlckVtYWlsICYmIHVzZXJFbWFpbC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHVzZXJTZWFyY2gudG9Mb3dlckNhc2UoKSk7XG4gICAgICB9KTtcblxuICAgICAgLy8gQWRkIGVtYWlsIHRvIHJlYWRpbmcgb2JqZWN0c1xuICAgICAgZmlsdGVyZWRSZWFkaW5ncyA9IGZpbHRlcmVkUmVhZGluZ3MubWFwKChyZWFkaW5nKSA9PiAoe1xuICAgICAgICAuLi5yZWFkaW5nLFxuICAgICAgICB1c2VyRW1haWw6IHVzZXJNYXAuZ2V0KHJlYWRpbmcudXNlcklkKSxcbiAgICAgIH0pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gU3RpbGwgZmV0Y2ggZW1haWxzIGZvciBkaXNwbGF5XG4gICAgICBjb25zdCB1c2VySWRzID0gWy4uLm5ldyBTZXQocmVhZGluZ3MubWFwKChyKSA9PiByLnVzZXJJZCkpXTtcbiAgICAgIGNvbnN0IHVzZXJQcm9taXNlcyA9IHVzZXJJZHMubWFwKGFzeW5jICh1c2VySWQpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCB1c2VyUmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoXG4gICAgICAgICAgICBuZXcgR2V0Q29tbWFuZCh7XG4gICAgICAgICAgICAgIFRhYmxlTmFtZTogVVNFUl9UQUJMRV9OQU1FLFxuICAgICAgICAgICAgICBLZXk6IHtcbiAgICAgICAgICAgICAgICB1c2VySWQ6IHVzZXJJZCxcbiAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6ICdQUk9GSUxFJyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIHVzZXJSZXN1bHQuSXRlbTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oYEZhaWxlZCB0byBmZXRjaCB1c2VyICR7dXNlcklkfTpgLCBlcnJvcik7XG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB1c2VycyA9IGF3YWl0IFByb21pc2UuYWxsKHVzZXJQcm9taXNlcyk7XG4gICAgICBjb25zdCB1c2VyTWFwID0gbmV3IE1hcCh1c2Vycy5maWx0ZXIoQm9vbGVhbikubWFwKCh1c2VyKSA9PiBbdXNlciEudXNlcklkLCB1c2VyIS5lbWFpbF0pKTtcblxuICAgICAgZmlsdGVyZWRSZWFkaW5ncyA9IHJlYWRpbmdzLm1hcCgocmVhZGluZykgPT4gKHtcbiAgICAgICAgLi4ucmVhZGluZyxcbiAgICAgICAgdXNlckVtYWlsOiB1c2VyTWFwLmdldChyZWFkaW5nLnVzZXJJZCksXG4gICAgICB9KSk7XG4gICAgfVxuXG4gICAgLy8gUHJlcGFyZSByZXNwb25zZVxuICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgcmVhZGluZ3M6IGZpbHRlcmVkUmVhZGluZ3MsXG4gICAgICBjb3VudDogZmlsdGVyZWRSZWFkaW5ncy5sZW5ndGgsXG4gICAgICBsYXN0RXZhbHVhdGVkS2V5OiBzY2FuUmVzdWx0Lkxhc3RFdmFsdWF0ZWRLZXlcbiAgICAgICAgPyBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShzY2FuUmVzdWx0Lkxhc3RFdmFsdWF0ZWRLZXkpKS50b1N0cmluZygnYmFzZTY0JylcbiAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgfTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgICB9LFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgICB9LFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSksXG4gICAgfTtcbiAgfVxufTtcbiJdfQ==